services:
  # Main Sparta Application Service
  sparta-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sparta-service
    ports:
      - "40813:7580"
    environment:
      - SERVER_PORT=7580
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/predator?useSSL=false&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_REDIS_PASSWORD=
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_VIRTUAL_HOST=/
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - JWT_USER_TTL=3600000
      - JWT_USER_TOKEN_NAME=Authorization
      - JWT_USER_SECRET_KEY=your-secret-key-change-in-production
      - SERVICE_ID=Nonaron-Service
      - MINION_NAME=Nonaron
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - sparta-network
    volumes:
      - ./target.jar:/app/target.jar
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7580/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  # MySQL Database (Internal - not exposed to host)
  mysql:
    image: mysql:8.0
    container_name: sparta-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=predator
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - sparta-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis Cache (Internal - not exposed to host)
  redis:
    image: redis:7-alpine
    container_name: sparta-redis
    networks:
      - sparta-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Queue (Internal - not exposed to host)
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: sparta-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
    networks:
      - sparta-network
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  sparta-network:
    driver: bridge

volumes:
  mysql-data: