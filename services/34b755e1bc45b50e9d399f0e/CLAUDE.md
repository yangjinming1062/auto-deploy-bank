# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the [Babel](https://babeljs.io/) repository - a JavaScript compiler that transforms modern JavaScript code into backwards-compatible versions. It's organized as a monorepo using Yarn workspaces, containing many npm packages including `@babel/core`, `@babel/parser`, plugins, and presets.

## Development Setup

### Prerequisites
- **Node.js**: Version >= 22.18.0
- **Yarn**: Version >= 4.0.0 (using Yarn 4 with workspaces)

### Initial Setup
```bash
# Fork and clone the repository
git clone https://github.com/<your-username>/babel
cd babel

# Install dependencies and bootstrap the monorepo
make bootstrap

# Build Babel (once)
make build

# Or build in watch mode for development
make watch
```

Built files are available in individual package directories: `packages/<package-name>/lib`

## Architecture

Babel's compiler follows a three-stage pipeline:

**Input Code** → **[@babel/parser](packages/babel-parser)** → **AST** → **Transformers** → **AST** → **[@babel/generator](packages/babel-generator)** → **Output Code**

### Core Packages
- **[@babel/core](packages/babel-core)**: The main compiler API
- **[@babel/parser](packages/babel-parser)**: Parses JavaScript into an AST
- **[@babel/traverse](packages/babel-traverse)**: Traverses and modifies the AST
- **[@babel/generator](packages/babel-generator)**: Generates code from the AST

### Supporting Packages
- **[@babel/cli](packages/babel-cli)**: Command-line interface
- **[@babel/types](packages/babel-types)**: AST node constructors and validators
- **[@babel/template](packages/babel-template)**: Helper for constructing AST nodes
- **[@babel/helpers](packages/babel-helpers)**: Pre-made helper functions for plugins
- **[@babel/runtime](packages/babel-runtime)**: Polyfills and helpers for libraries
- **[@babel/register](packages/babel-register)**: On-the-fly compilation via require hook

The monorepo structure is documented in [doc/design/monorepo.md](doc/design/monorepo.md).

## Common Commands

### Building
```bash
make build              # Build all packages once
make build-dist         # Build distribution bundles
make watch              # Watch mode for incremental builds
make bootstrap          # Initial setup (also used to update after dependency changes)
```

### Linting and Formatting
```bash
make lint               # Run ESLint on all files (~19 sec)
make fix                # Auto-fix ESLint issues
```

ESLint configuration uses `eslint.config.mts` at the repo root. Prettier is configured via `.prettierrc`.

### Testing
```bash
make test               # Run all tests + lint (~32 sec)
make test-only          # Run tests without lint
yarn jest               # Run Jest directly

# Run tests for a specific package
yarn jest babel-cli
yarn jest classes       # Also matches substrings

# Run tests matching a name pattern
yarn jest -t transformation
yarn jest -t "arrow functions destructuring parameters"

# Set environment variables for specific test scenarios
BABEL_8_BREAKING=true yarn jest              # Run Babel 8 compatibility tests
TEST_ONLY=babel-parser make test-only         # Test single package
TEST_GREP="pattern" make test-only            # Filter by regex
TEST_DEBUG=true make test-only                # Enable Node debugger
OVERWRITE=true yarn jest babel-parser         # Regenerate test fixtures
```

### Debugging Tests
```bash
# Start Node debugger with Jest
yarn run --inspect-brk jest -i packages/package-to-test

# Debug specific test
yarn run --inspect-brk jest -i babel-parser -t "test name" --testTimeout=500000

# With environment variable
TEST_DEBUG=true make test-only
```

### Yarn-Specific Commands
```bash
yarn --immutable-cache  # Update lockfile for releases
yarn test:esm          # Run ES module tests
```

## Test Structure

### Plugin Tests
Most packages use fixture-based tests in `test/fixtures` with this structure:
```
test/fixtures/
  feature-name/
    input.js           # Source code to transform
    output.js          # Expected output (auto-generated if missing)
    exec.js            # Runtime test that executes the code
    options.json       # Babel configuration for this test
```

### Parser Tests
Parser tests in `packages/babel-parser/test/fixtures` use:
- `input.js`: Code to parse
- `output.json`: Expected AST output (auto-generated if missing)

### Test Configuration
`options.json` supports special properties:
- `throws`: Expected error message
- `minNodeVersion`: Minimum Node version required
- `externalHelpers`: Toggle `@babel/plugin-external-helpers`

Test fixtures can be auto-generated by running tests with `OVERWRITE=true`.

## Editor Configuration

VSCode settings are available in `.vscode/settings.example.json` with:
- JSON schema validation for `options.json` files in test fixtures
- JavaScript/TypeScript formatting with Prettier
- ESLint auto-fix on save
- Debug configuration for outFiles

To use these settings, copy to `.vscode/settings.json`.

## Babel Version Transitions

Babel is transitioning from v7 to v8. Test with:
```bash
BABEL_8_BREAKING=true yarn jest
```

Some tests maintain separate v7/v8 fixtures.

## Package Structure

Each package typically contains:
- `src/` - TypeScript source files
- `lib/` - Compiled JavaScript (built from `src/`)
- `test/` - Test files and fixtures
- `README.md` - Package documentation
- `package.json` - Package configuration

## Internal Documentation

Key architectural docs are in `doc/`:
- `doc/design/monorepo.md` - Why this is a monorepo
- `doc/design/versioning.md` - Versioning strategy
- `doc/ast/spec.md` - Babel AST specification
- `doc/design/compiler-environment-support.md` - Supported environments
- `doc/design/compiler-assumptions.md` - Compiler assumptions

## Contributing Guidelines

When working on Babel:
1. **Parser changes**: Update both the parser and `packages/babel-parser/ast/spec.md`
2. **New syntax**: Follow the [spec-new plugin creation process](CONTRIBUTING.md#creating-a-new-plugin-spec-new)
3. **Test updates**: Run `OVERWRITE=true` to regenerate fixtures after fixing bugs
4. **TypeScript**: Most code is TypeScript, compiled during build
5. **Breaking changes**: Test with `BABEL_8_BREAKING=true`

## Useful Resources

- [Babel Plugin Handbook](https://github.com/thejameskyle/babel-handbook/blob/master/translations/en/plugin-handbook.md)
- [AST Explorer](http://astexplorer.net) - Visualize ASTs
- [Babel Website](https://babeljs.io) - Documentation
- [Slack Community](https://slack.babeljs.io) - Join #development channel

## Build System Notes

- Uses Gulp for the build pipeline (see `Gulpfile.mts`)
- Makefile wraps build scripts (`Makefile.mjs` is the source, `Makefile.mjs` is auto-generated)
- Each package has its own `tsconfig.json` configuration
- TypeScript definitions use TypeScript project references (`tsconfig.paths.json`)