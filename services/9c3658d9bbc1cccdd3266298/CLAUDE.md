# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Agent Squad is a dual-language (Python and TypeScript) framework for orchestrating multiple AI agents to handle complex conversations. The framework features intelligent intent classification, flexible agent responses (streaming/non-streaming), context management, and extensible architecture supporting AWS services (Bedrock, Lex, Lambda), Anthropic, and OpenAI.

**Repository structure:**
- `python/` - Python implementation
- `typescript/` - TypeScript implementation
- `docs/` - Documentation
- `examples/` - Example applications (17 different examples)
- `.github/workflows/` - CI/CD workflows

## Development Commands

### TypeScript

```bash
cd typescript

# Install dependencies
npm install

# Build the project
npm run build

# Run tests with coverage
npm run coverage
# or just: npm test

# Lint code
npm run lint

# Run specific test
npm test -- --testNamePattern="TestName"
```

**Test framework:** Jest with ts-jest preset
**Linting:** ESLint with TypeScript plugin and Prettier
**TypeScript config:** `typescript/tsconfig.json`

### Python

```bash
cd python

# Install test dependencies
pip install -r test_requirements.txt

# Run tests
make test

# Code quality check (ruff)
make code-quality

# Run specific test
pytest ./src/tests/test_orchestrator.py -v

# Build package
python -m build
```

**Test framework:** pytest with asyncio marker support
**Linting:** ruff (see `python/ruff.toml`)
**Python versions:** 3.11, 3.12, 3.13

## Code Architecture

### Core Components (Same in both Python and TypeScript)

1. **Orchestrator** (`orchestrator.ts` / `orchestrator.py`)
   - Central routing logic that receives requests
   - Routes queries to appropriate agents based on classifier results
   - Manages conversation storage and context

2. **Agents** (`/agents/`)
   - Various agent implementations:
     - `bedrockLLMAgent.ts/py` - AWS Bedrock LLM with Converse API
     - `bedrockTranslatorAgent.ts/py` - Translation agent
     - `lexBotAgent.ts/py` - Amazon Lex bot integration
     - `openAIAgent.ts/py` - OpenAI integration
     - `lambdaAgent.ts/py` - AWS Lambda invocation
     - `comprehendFilterAgent.ts/py` - Content filtering
     - `supervisorAgent` - Team coordination (parallel processing, multiple specialized agents)
   - Each agent implements a consistent interface
   - Support both streaming and non-streaming responses

3. **Classifiers** (`/classifiers/`)
   - Intelligent routing based on agent characteristics and conversation history
   - Implementations: Bedrock, Anthropic, OpenAI
   - Selects the most appropriate agent for each query

4. **Storage** (`/storage/`)
   - Conversation persistence:
     - `dynamoDbChatStorage.ts/py` - AWS DynamoDB
     - `sqlChatStorage.ts/py` - SQL databases
     - `memoryChatStorage.ts/py` - In-memory
     - `inMemoryChatStorage.py` - Python variant

5. **Retrievers** (`/retrievers/`)
   - Context retrieval for agents:
     - `amazonKbRetriever.ts/py` - Amazon Knowledge Base

6. **Utils** (`/utils/`)
   - `logger.ts/py` - Logging utilities
   - `tool.ts/py` - Tool definitions
   - `chatUtils.ts` - Chat-specific utilities (TypeScript)
   - `helpers.py` - General helpers (Python)

7. **Types** (`/types/`)
   - Shared type definitions for consistent interfaces

### High-Level Flow

```
User Input → Classifier → Orchestrator → Selected Agent → Response
                 ↓              ↓              ↓
           Characteristics  Storage      Streaming/Non-streaming
           + History       Context
```

## Key Implementation Details

### TypeScript Entry Point
- `typescript/src/index.ts` - Main entry point
- Exports: `AgentSquad`, agent classes, classifier classes, storage classes

### Python Package Structure
- Package name: `agent_squad`
- Location: `python/src/agent_squad/`
- Installation extras:
  - `agent-squad[aws]` - AWS integrations
  - `agent-squad[anthropic]` - Anthropic
  - `agent-squad[openai]` - OpenAI
  - `agent-squad[all]` - All integrations

### SupervisorAgent (New Feature)
Implements "agent-as-tools" architecture for team coordination:
- Multiple specialized agents working in parallel
- Smart context management across team members
- Dynamic task delegation
- Can be used directly or integrated into classifier systems

## Testing Strategy

### TypeScript
- Unit tests in `typescript/tests/`
- Mock AWS services using `aws-sdk-client-mock`
- Test files: `*.test.ts`
- Coverage reports generated by Jest

### Python
- Unit tests in `python/src/tests/`
- Uses `moto` for AWS service mocking
- Uses `pytest-asyncio` for async tests
- Test files: `test_*.py`
- Run from `python/` directory

## Examples (17 Total)

Located in `examples/` directory:
- `chat-demo-app/` - Streamlit multi-agent demo
- `ecommerce-support-simulator/` - Customer support system
- `chat-chainlit-app/` - Chainlit chat app
- `fast-api-streaming/` - FastAPI with streaming
- `text-2-structured-output/` - NLP to structured data
- `bedrock-inline-agents/` - Bedrock inline agents
- `bedrock-prompt-routing/` - Prompt routing sample
- `bedrock-flows/` - Bedrock Flows integration
- `supervisor-mode/` - SupervisorAgent examples
- `strands-agents-demo/` - Strands agents integration
- `langfuse-demo/` - Observability with Langfuse
- `local-demo/`, `python-demo/` - Local development demos
- `tools/` - Utility tools

## Contributing Workflow

**Issue-First Policy:** Every PR must be linked to an existing issue

1. Create an issue to discuss changes
2. Wait for approval
3. Fork and create a feature branch
4. Make changes following project structure
5. Ensure tests pass locally
6. Submit PR with issue reference (Fixes/Resolves/Closes)
7. CI automatically verifies PR-issue linking

See `CONTRIBUTING.md` for full guidelines.

## Important Configuration Files

- `typescript/package.json` - npm scripts and dependencies
- `typescript/.eslintrc.js` - ESLint rules
- `typescript/jest.config.js` - Jest configuration
- `typescript/tsconfig.json` - TypeScript config
- `python/setup.cfg` - Python package metadata
- `python/pyproject.toml` - Build system config
- `python/ruff.toml` - Linting rules
- `python/Makefile` - Test and quality commands
- `python/test_requirements.txt` - Testing dependencies

## Package Installation

### TypeScript
```bash
npm install agent-squad
```

### Python
```bash
pip install agent-squad[aws]          # AWS integrations
pip install agent-squad[anthropic]    # Anthropic
pip install agent-squad[openai]       # OpenAI
pip install agent-squad[all]          # All features
```

## CI/CD

Automated workflows in `.github/workflows/`:
- `py-run-tests.yml` - Python tests (multi-version: 3.11-3.13)
- `ts-run-tests.yml` - TypeScript tests with coverage
- `ts-run-lint.yml` - TypeScript linting
- `pr-issue-link-checker.yml` - Enforces issue-PR linking
- `npm-publish.yml` & `pypi-publish.yml` - Package publishing