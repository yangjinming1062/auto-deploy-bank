services:
  web:
    container_name: chat_web
    build: .
    command: python app.py
    restart: unless-stopped
    environment:
      - APP_PORT=5000
      - APP_DEBUG=False
      - CONTENT_DIR=/home/ubuntu/deploy-projects/c994539d92609e7f20803122/content
      # INFINITY_INSTANCE_URL - Required: URL for Infinity embedding service (e.g., http://infinity:7997)
      - EMBEDDING_MODEL=all-MiniLM-L6-v2
      - OLLAMA_INSTANCE_URL=http://ollama:11434
      - MODEL=llama3.2
      - OPENSEARCH_HOSTNAME=opensearch-node1
      - OPENSEARCH_REST_API_PORT_HOST=9200
      - OPENSEARCH_USER=admin
      - OPENSEARCH_PASSWORD=admin
    ports:
      - "41650:5000"
    healthcheck:
      test: ["CMD-SHELL", "(echo > /dev/tcp/localhost/5000) >/dev/null 2>&1 && exit 0 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on: []
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  ollama:
    container_name: chat_ollama
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes:
      - ./volumes/ollama:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=5m
    healthcheck:
      test: ["CMD-SHELL", "(echo > /dev/tcp/localhost/11434) >/dev/null 2>&1 && exit 0 || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 20
      start_period: 600s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  opensearch-node1:
    container_name: chat_opensearch_opensearch_node1
    image: opensearchproject/opensearch:1.3.15
    restart: unless-stopped
    environment:
      - cluster.name=docker-cluster
      - node.name=opensearch-node1
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=admin
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "(echo > /dev/tcp/localhost/9200) >/dev/null 2>&1 && exit 0 || exit 1",
        ]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G