services:
  agentops-api:
    build:
      context: ./app
      dockerfile: api/Dockerfile
    ports:
      - '40583:8000'
    environment:
      - PYTHONUNBUFFERED=1
      # Supabase Configuration (from app/.env)
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-http://127.0.0.1:54321}
      - SUPABASE_URL=${SUPABASE_URL:-http://127.0.0.1:54321}
      - SUPABASE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU}
      # Domain Configuration
      - PROTOCOL=${PROTOCOL:-http}
      - API_DOMAIN=${API_DOMAIN:-localhost:8000}
      - APP_DOMAIN=${APP_DOMAIN:-localhost:3000}
      - APP_URL=${APP_URL:-http://localhost:3000}
      # Supabase PostgreSQL Direct Connection
      - SUPABASE_HOST=${SUPABASE_HOST:-127.0.0.1}
      - SUPABASE_PORT=${SUPABASE_PORT:-54322}
      - SUPABASE_DATABASE=${SUPABASE_DATABASE:-postgres}
      - SUPABASE_USER=${SUPABASE_USER:-postgres}
      - SUPABASE_PASSWORD=${SUPABASE_PASSWORD:-postgres}
      - SUPABASE_SSLMODE=${SUPABASE_SSLMODE:-disable}
      - SUPABASE_MIN_POOL_SIZE=${SUPABASE_MIN_POOL_SIZE:-1}
      - SUPABASE_MAX_POOL_SIZE=${SUPABASE_MAX_POOL_SIZE:-10}
      # Redis Configuration (optional - will disable caching if not set)
      - REDIS_HOST=${REDIS_HOST:-}
      - REDIS_PORT=${REDIS_PORT:-}
      # Logging
      - LOGGING_LEVEL=${LOGGING_LEVEL:-INFO}
      # JWT Secret
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-development-secret-key-change-in-production}
      # Rate Limiting
      - RATE_LIMIT_ENABLE=${RATE_LIMIT_ENABLE:-false}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G