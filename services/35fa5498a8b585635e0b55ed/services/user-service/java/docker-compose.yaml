services:
  user-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "41634:8901"
    environment:
      - SERVER_PORT=8901
      - POSTGRESQLURL=${POSTGRESQLURL:-jdbc:postgresql://miyagi-pg.postgres.database.azure.com:5432/miyagi?sslmode=require}
      - POSTGRESQLUSER=${POSTGRESQLUSER:-miyagi_user}
      - POSTGRESQLPASSWORD=${POSTGRESQLPASSWORD}
      - KAFKABOOTSTRAPSERVERS=${KAFKABOOTSTRAPSERVERS}
      - KAFKATOPICNAME=${KAFKATOPICNAME:-miyagi}
      - KAFKATOPICGROUP=${KAFKATOPICGROUP:-user-service}
      - KAFKASECURITYPROTOCOL=${KAFKASECURITYPROTOCOL:-PLAINTEXT}
      - KAFKASASLMECHANISM=${KAFKASASLMECHANISM:-PLAIN}
      - KAFKASASLJAASCONFIG=${KAFKASASLJAASCONFIG}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-https://gk-oai.openai.azure.com/}
      - AZURE_OPENAI_MODEL_ID=${AZURE_OPENAI_MODEL_ID:-gk-gpt-35}
      - AZUREREDISHOST=${AZUREREDISHOST}
      - AZUREREDISPORT=${AZUREREDISPORT:-6380}
      - AZUREREDISACCESSKEY=${AZUREREDISACCESSKEY}
      - AZURECOSMOSDBURI=${AZURECOSMOSDBURI}
      - AZURECOSMOSDBKEY=${AZURECOSMOSDBKEY}
      - AZURECOSMOSDBSECONDARYKEY=${AZURECOSMOSDBSECONDARYKEY}
      - AZURECOSMOSDBDATABASENAME=${AZURECOSMOSDBDATABASENAME:-miyagi}
      - AZURESTORAGEACCOUNTNAME=${AZURESTORAGEACCOUNTNAME}
      - AZURESTORAGEACCOUNTKEY=${AZURESTORAGEACCOUNTKEY}
      - AZURESTORAGEENDPOINT=${AZURESTORAGEENDPOINT}
      - APPLICATIONINSIGHTS_CONNECTION_STRING=${APPLICATIONINSIGHTS_CONNECTION_STRING}
      - SK_BASE_URL=${SK_BASE_URL:-http://localhost:7071}
    volumes:
      - ./target.jar:/app/app.jar
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8901/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped