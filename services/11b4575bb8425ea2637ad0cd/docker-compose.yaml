services:
  coherence:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coherence-service
    ports:
      - "40607:6676"
    environment:
      - COHERENCE_CLUSTER=coherence
      - COHERENCE_MODE=dev
      - COHERENCE_EDITION=CE
      - COHERENCE_SECURITY=false
      - COHERENCE_WKA=
      - COHERENCE_LOCALHOST=
      - COHERENCE_LOCALPORT=0
      - COHERENCE_CLUSTERADDRESS=239.192.0.0
      - COHERENCE_CLUSTERPORT=7574
      - COHERENCE_SOCKETPROVIDER=system
      - COHERENCE_DISTRIBUTED_LOCALSTORAGE=true
      - COHERENCE_DISTRIBUTED_PARTITIONCOUNT=257
      - COHERENCE_DISTRIBUTED_BACKUPCOUNT=1
      - COHERENCE_PROXY_THREADS=
      - COHERENCE_MANAGEMENT=dynamic
      - COHERENCE_MANAGEMENT_HTTP=all
      - COHERENCE_LOG=stderr
      - COHERENCE_LOG_LEVEL=5
      - COHERENCE_CACHECONFIG=coherence-cache-config.xml
      - COHERENCE_POF_CONFIG=pof-config.xml
      - COHERENCE_SECURITY_KEYSTORE=
      - COHERENCE_SECURITY_PASSWORD=
      - COHERENCE_HEALTH_HTTP_PORT=6676
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:6676/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: coherence-web
    ports:
      - "40525:80"
    depends_on:
      - coherence
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped