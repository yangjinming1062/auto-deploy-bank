services:
  sonarqube:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sonarqube
    ports:
      - "41028:9000"
    environment:
      - SONAR_WEB_HOST=0.0.0.0
      - SONAR_WEB_PORT=9000
      - SONAR_SEARCH_HOST=127.0.0.1
      - SONAR_SEARCH_PORT=9001
      - SONAR_CLUSTER_ENABLED=false
      # JVM options
      - SONAR_SEARCH_JAVAOPTS=-Xms512m -Xmx512m -XX:MaxDirectMemorySize=256m
      - SONAR_WEB_JAVAOPTS=-Xmx512m -Xms128m
      - SONAR_CE_JAVAOPTS=-Xmx512m -Xms128m
    volumes:
      # Security scanning: JAR file for security scanning
      - ./target.jar:/scanning/target.jar
      # Persist SonarQube data
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_temp:/opt/sonarqube/temp
      - sonarqube_extensions:/opt/sonarqube/extensions
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9000/ -q && exit 0 || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 180s
    restart: unless-stopped

volumes:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_temp:
  sonarqube_extensions: