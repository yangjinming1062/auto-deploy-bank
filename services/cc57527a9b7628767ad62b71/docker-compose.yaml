version: "3"
# Never use this in a production environment.
services:
  consoleme:
    build: .
    ports:
      - "40472:8081"
    tty: true
    stdin_open: true
    environment:
      - CONFIG_LOCATION=/apps/consoleme/example_config/example_config_docker_local.yaml
      - EC2_REGION=us-east-1
      - AWS_REGION=us-east-1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - ENVIRONMENT=test
    depends_on:
      consoleme-redis:
        condition: service_healthy
      consoleme-dynamodb:
        condition: service_started
      consoleme-localstack:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  consoleme-celery:
    build: .
    tty: true
    stdin_open: true
    environment:
      - CONFIG_LOCATION=/apps/consoleme/example_config/example_config_docker_local.yaml
      - EC2_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - ENVIRONMENT=test
      - COLUMNS=80 # Needed for Celery: https://github.com/celery/celery/issues/5761
    depends_on:
      consoleme-redis:
        condition: service_healthy
      consoleme-dynamodb:
        condition: service_started
      consoleme-localstack:
        condition: service_started
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  consoleme-redis:
    image: redis:6-alpine
    ports: []
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  consoleme-dynamodb:
    image: amazon/dynamodb-local:latest
    ports: []
    command: -jar DynamoDBLocal.jar -sharedDb -inMemory -port 8005
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  consoleme-localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
      - "4571:4571"
    environment:
      - SERVICES=sts,iam,ec2,eks,lambda,route53,s3,secretsmanager
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M