# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## About This Project

Kubeflow Katib is a Kubernetes-native project for automated machine learning (AutoML). It supports Hyperparameter Tuning, Early Stopping, and Neural Architecture Search. Katib is framework-agnostic and works with TensorFlow, PyTorch, XGBoost, and other ML frameworks. See [README.md](./README.md) for more details.

## Project Structure

This is a Go project (Go 1.24.0) with the following main components:

- **`cmd/`** - Main executables
  - `katib-controller/` - Kubernetes controller for Katib resources
  - `suggestion/` - Hyperparameter optimization algorithms (goptuna, hyperband, hyperopt, optuna, pbt, skopt, nas)
  - `earlystopping/` - Early stopping algorithms (medianstop)
  - `db-manager/` - Database manager for storing experiment data
  - `metricscollector/` - Metrics collection services
  - `ui/` - Web UI for experiments

- **`pkg/apis/`** - Kubernetes API definitions
  - `controller/` - Katib CRD types (Experiment, Suggestion, Trial)
  - `manager/` - gRPC API definitions
  - `v1beta1/` - v1beta1 API versions

- **`pkg/controller.v1beta1/`** - Controller logic for Katib resources

- **`test/unit/v1beta1/`** - Python SDK and service unit tests

- **`manifests/v1beta1/`** - Kustomize deployment manifests

## Common Development Commands

```bash
# Run all checks (generated codes, go mod, fmt, vet, lint)
make check

# Run Go unit tests
make test

# Run specific linting tools
make lint          # golangci-lint
make fmt           # verify gofmt
make yamllint      # verify YAML files
make shellcheck    # verify shell scripts

# Generate code (controllers, SDK, mocks, protobuf)
make generate

# Format Go code
make update

# Run Python SDK tests
make prepare-pytest
make pytest        # Note: Requires Python 3.11+

# Build container images
make build REGISTRY=<registry> TAG=<tag>

# Deploy to Kubernetes cluster
make deploy
make undeploy
```

To run a single Go test:
```bash
go test ./pkg/controller.v1beta1/experiment/... -v
```

## Key Development Notes

- **Controller APIs**: If you modify Katib CRDs in `pkg/apis/controller/`, run `make generate` to update:
  - Deepcopy, clientset, listers, informers
  - OpenAPI definitions
  - Python SDK
  - gRPC manager APIs
  - Go mock codes

- **Admission Webhooks**: Katib uses three admission webhooks:
  - `validator.experiment.katib.kubeflow.org` - Validates Experiment resources
  - `defaulter.experiment.katib.kubeflow.org` - Sets default values
  - `mutator.pod.katib.kubeflow.org` - Injects metrics collector sidecar
  - Webhook certs are auto-generated by `cert-generator` (see `pkg/certgenerator/`)

- **Testing Guidelines**:
  - Use `cmp.Diff` from `github.com/google/go-cmp` for comparisons
  - Define test cases as maps with test case names as keys

- **Pre-commit Hooks**: Install and use pre-commit hooks (see `.pre-commit-config.yaml`) before committing

## Algorithm Service Architecture

Katib supports pluggable optimization algorithms. Each algorithm runs as a separate service communicating with the controller via gRPC:

- **Goptuna** (cmd/suggestion/goptuna/)
- **Hyperopt** (cmd/suggestion/hyperopt/)
- **Optuna** (cmd/suggestion/optuna/)
- **Skopt** (cmd/suggestion/skopt/)
- **HyperBand** (cmd/suggestion/hyperband/)
- **Population Based Training** (cmd/suggestion/pbt/)
- **Neural Architecture Search** (cmd/suggestion/nas/ with ENAS and DARTS)

Each service implements the Suggestion gRPC API defined in `pkg/apis/manager/v1beta1/`.

## Database Integration

Katib supports multiple database backends (MySQL, PostgreSQL) via the db-manager service. The DB manager exposes a gRPC API for storing and retrieving experiment, trial, and observation data.

## SDK

- **Python SDK**: `sdk/python/v1beta1/` - Install with `pip install -U kubeflow-katib`
- Supports creating and managing Experiments programmatically

## Testing

- **Python Tests**: Run via `make pytest` (requires Python 3.11+)
- **Go Tests**: Run via `make test` (uses envtest for Kubernetes API simulation)
- **Conformance**: Tests available in `conformance/` directory

## Troubleshooting

- If building on Apple Silicon with Docker: disable "Use Rosetta for x86_64/amd64 emulation" in Docker Desktop
- For private clusters: allow TCP:8443 traffic for admission webhooks
- skopt service tests require Python 3.9 (run with `make pytest-skopt`)

## Additional Resources

- [Kubeflow Katib Documentation](https://www.kubeflow.org/docs/components/katib/)
- [CONTRIBUTING.md](./CONTRIBUTING.md) - Detailed development guide
- [ROADMAP.md](./ROADMAP.md) - Project roadmap
- [examples/v1beta1/](examples/v1beta1/) - Example experiments and configurations