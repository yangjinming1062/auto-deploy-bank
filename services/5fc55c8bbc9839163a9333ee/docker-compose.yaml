services:
  flowableui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: y9-flowableui
    ports:
      - "40801:8080"
    environment:
      # Nacos Configuration
      NACOS_PASSWORD: $${NACOS_PASSWORD:-111111}
      spring.cloud.nacos.server-addr: $${spring.cloud.nacos.server-addr:-https://test.youshengyun.com:443}
      spring.cloud.nacos.username: $${spring.cloud.nacos.username:-nacos}
      spring.cloud.nacos.password: $${spring.cloud.nacos.password:-111111}
      spring.cloud.nacos.discovery.namespace: test
      spring.cloud.nacos.discovery.group: DEFAULT_GROUP

      # Database Configuration (MySQL)
      spring.datasource.druid.y9-public.url: jdbc:mysql://mysql:3306/y9_public?serverTimezone=GMT%2B8&nullCatalogMeansCurrent=true&useUnicode=true&characterEncoding=utf-8&rewriteBatchedStatements=true&useCompression=true&useSSL=false
      spring.datasource.druid.y9-public.username: root
      spring.datasource.druid.y9-public.password: $${MYSQL_ROOT_PASSWORD:-111111}
      spring.datasource.druid.flowable.url: jdbc:mysql://mysql:3306/y9_flowable?serverTimezone=GMT%2B8&nullCatalogMeansCurrent=true&useUnicode=true&characterEncoding=utf-8&rewriteBatchedStatements=true&useCompression=true&useSSL=false
      spring.datasource.druid.flowable.username: root
      spring.datasource.druid.flowable.password: $${MYSQL_ROOT_PASSWORD:-111111}

      # Redis Configuration
      spring.redis.host: redis
      spring.redis.port: 6379
      spring.redis.password: $${REDIS_PASSWORD:-111111}
      spring.redis.database: 8

      # Kafka Configuration
      spring.kafka.bootstrap-servers: kafka:9092

      # Application Settings
      server.port: 8080
      server.servlet.context-path: /server-flowableui
      spring.application.name: flowableUI

      # File Processing
      file.dir: /tmp/y9-file-store
      delete.password: $${delete.password:-123456}

      # Logging
      logging.level.root: INFO
      y9.app.flowable.log.enabled: true
      y9.app.flowable.log.reportMethod: kafka

    volumes:
      # Mount JAR file from host for security scanning
      - ./target.jar:/app/target.jar:ro
      # File storage
      - y9-file-store:/tmp/y9-file-store
      # Logs
      - ./logs:/app/logs
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/server-flowableui/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - y9-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      zookeeper:
        condition: service_started
      kafka:
        condition: service_started
      elasticsearch:
        condition: service_started
      nacos:
        condition: service_started

  mysql:
    image: mysql:8.0
    container_name: y9-mysql
    environment:
      MYSQL_ROOT_PASSWORD: $${MYSQL_ROOT_PASSWORD:-111111}
      MYSQL_DATABASE: y9_public
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD:-111111}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - y9-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  redis:
    image: redis:7-alpine
    container_name: y9-redis
    command: redis-server --requirepass $${REDIS_PASSWORD:-111111} --port 6379
    volumes:
      - redis-data:/data
    networks:
      - y9-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: y9-kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka
    depends_on:
      - zookeeper
    networks:
      - y9-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: y9-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - y9-network
    healthcheck:
      test: ["CMD", "zkServer.sh", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: y9-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx1g"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - y9-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  nacos:
    image: nacos/nacos-server:v2.4.3
    container_name: y9-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/y9_public?serverTimezone=GMT%2B8&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: $${MYSQL_ROOT_PASSWORD:-111111}
      NACOS_AUTH_ENABLE: "true"
      NACOS_AUTH_IDENTITY_KEY: y9flowable
      NACOS_AUTH_IDENTITY_VALUE: risesoft2024
      NACOS_AUTH_TOKEN: SecretKey0123456789abcdefghijklmnopqrstuvwxyz
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-logs:/home/nacos/logs
    networks:
      - y9-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8848/nacos/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  y9-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  kafka-data:
  es-data:
  nacos-data:
  nacos-logs:
  y9-file-store: