services:
  jiron-mysql:
    container_name: jiron-mysql
    image: mysql:5.7
    build:
      context: ./mysql
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/conf:/etc/mysql/conf.d
      - ./mysql/logs:/logs
      - ./mysql/data:/var/lib/mysql
    command: [
          'mysqld',
          '--innodb-buffer-pool-size=80M',
          '--character-set-server=utf8mb4',
          '--collation-server=utf8mb4_unicode_ci',
          '--default-time-zone=+8:00',
          '--lower-case-table-names=1'
        ]
    environment:
      MYSQL_DATABASE: 'ry-cloud'
      MYSQL_ROOT_PASSWORD: password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  jiron-redis:
    container_name: jiron-redis
    image: redis
    build:
      context: ./redis
    ports:
      - "6379:6379"
    volumes:
      - ./redis/conf/redis.conf:/home/jiron/redis/redis.conf
      - ./redis/data:/data
    command: redis-server /home/jiron/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 30s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

  jiron-nacos:
    container_name: jiron-nacos
    image: nacos/nacos-server:v2.3.2
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=jiron-mysql
      - MYSQL_SERVICE_DB_NAME=ry-cloud
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=password
      - NACOS_AUTH_TOKEN_EXPIRE_TIME=18000
      - NACOS_AUTH_TOKEN=SkbBMzJXMzAxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTA=
      - NACOS_AUTH_IDENTITY_KEY=admin
      - NACOS_AUTH_IDENTITY_VALUE=admin
    volumes:
      - ./nacos/logs/:/home/nacos/logs
      - ./nacos/conf/application.properties:/home/nacos/conf/application.properties
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    depends_on:
      jiron-mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  jiron-gateway:
    container_name: jiron-gateway
    build:
      context: ../
      dockerfile: Dockerfile
    image: 82345385b8d90ccc2e68d983-jiron-gateway:latest
    expose:
      - "8080"
    depends_on:
      jiron-redis:
        condition: service_healthy
      jiron-nacos:
        condition: service_healthy
    environment:
      - NACOS_HOST=jiron-nacos:8848
      - SPRING_PROFILES_ACTIVE=dev
    volumes:
      - ./target.jar:/app/target.jar
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  jiron-nginx:
    container_name: jiron-nginx
    image: nginx:alpine
    ports:
      - "43764:80"
    volumes:
      - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/html:/home/jiron/projects/jiron-ui
    depends_on:
      - jiron-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

# Services below are commented out - they require individual Dockerfiles to be created first
#  jiron-auth:
#    container_name: jiron-auth
#    image: 82345385b8d90ccc2e68d983-jiron-auth:latest
#    build:
#      context: ../../jiron-auth
#      dockerfile: Dockerfile
#    ports:
#      - "9204:9204"
#    depends_on:
#      jiron-redis:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9204/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.5'
#          memory: 3G
#        reservations:
#          cpus: '0.75'
#          memory: 1G

#  jiron-modules-system:
#    container_name: jiron-modules-system
#    image: 82345385b8d90ccc2e68d983-jiron-modules-system:latest
#    build:
#      context: ../../jiron-modules/jiron-system
#      dockerfile: Dockerfile
#    ports:
#      - "9201:9201"
#    depends_on:
#      jiron-redis:
#        condition: service_healthy
#      jiron-mysql:
#        condition: service_healthy
#      jiron-nacos:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9201/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.5'
#          memory: 3G
#        reservations:
#          cpus: '0.75'
#          memory: 1G

#  jiron-modules-gen:
#    container_name: jiron-modules-gen
#    image: 82345385b8d90ccc2e68d983-jiron-modules-gen:latest
#    build:
#      context: ../../jiron-modules/jiron-gen
#      dockerfile: Dockerfile
#    ports:
#      - "9202:9202"
#    depends_on:
#      jiron-mysql:
#        condition: service_healthy
#      jiron-nacos:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9202/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 2G
#        reservations:
#          cpus: '0.5'
#          memory: 1G

#  jiron-modules-job:
#    container_name: jiron-modules-job
#    image: 82345385b8d90ccc2e68d983-jiron-modules-job:latest
#    build:
#      context: ../../jiron-modules/jiron-job
#      dockerfile: Dockerfile
#    ports:
#      - "9203:9203"
#    depends_on:
#      jiron-mysql:
#        condition: service_healthy
#      jiron-nacos:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9203/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 2G
#        reservations:
#          cpus: '0.5'
#          memory: 1G

#  jiron-modules-file:
#    container_name: jiron-modules-file
#    image: 82345385b8d90ccc2e68d983-jiron-modules-file:latest
#    build:
#      context: ../../jiron-modules/jiron-file
#      dockerfile: Dockerfile
#    ports:
#      - "9300:9300"
#    depends_on:
#      jiron-nacos:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./jiron/uploadPath:/home/jiron/uploadPath
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9300/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 2G
#        reservations:
#          cpus: '0.5'
#          memory: 1G

#  jiron-visual-monitor:
#    container_name: jiron-visual-monitor
#    image: 82345385b8d90ccc2e68d983-jiron-visual-monitor:latest
#    build:
#      context: ../../jiron-visual/jiron-monitor
#      dockerfile: Dockerfile
#    ports:
#      - "9100:9100"
#    depends_on:
#      jiron-nacos:
#        condition: service_healthy
#    environment:
#      - NACOS_HOST=jiron-nacos:8848
#    volumes:
#      - ./target.jar:/app/target.jar
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9100/actuator/health"]
#      interval: 30s
#      timeout: 30s
#      retries: 10
#      start_period: 180s
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 2G
#        reservations:
#          cpus: '0.5'
#          memory: 1G