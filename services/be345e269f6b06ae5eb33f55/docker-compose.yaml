services:
  langchain-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: langchain-dev
    ports:
      - "40097:41580"
    environment:
      - NODE_ENV=production
      - PORT=41580
      - PNPM_VERSION=10.14.0
    working_dir: /app
    command: ["node", "server.js"]
    # Resource limits to prevent consuming all system resources
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "sh", "-c", "apk add --no-cache curl > /dev/null 2>&1 && curl -f http://localhost:${PORT}/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: Run tests in a separate service
  langchain-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: langchain-test
    profiles:
      - testing
    environment:
      - NODE_ENV=test
      - PNPM_VERSION=10.14.0
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - /app/libs/*/node_modules
    working_dir: /app
    command: pnpm test:unit
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Optional: Build all packages
  langchain-build:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: langchain-build
    profiles:
      - build
    environment:
      - NODE_ENV=production
      - PNPM_VERSION=10.14.0
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - /app/libs/*/node_modules
    working_dir: /app
    command: pnpm build
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

volumes:
  node_modules:
    driver: local