# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

aiohttp is a high-performance asynchronous HTTP client/server framework for Python (3.10+), built on asyncio. It supports HTTP/1.1, WebSockets (client/server), multipart handling, and provides a web server with middleware and pluggable routing.

## Common Commands

```bash
# Development setup (compiles Cython extensions)
make develop

# Run tests
make test          # Quick mode
make vtest         # Verbose
make vvtest        # Very verbose

# Run linting and formatting
make lint          # Includes mypy + format checks
make fmt           # Run black/isort via pre-commit

# Single test file
pytest tests/test_client_session.py -v

# Build docs
make doc
```

## Architecture

### Core Package Structure (`aiohttp/`)

- **Client**: `client.py` - `ClientSession` and HTTP client implementation
- **Server**: `web.py`, `web_app.py`, `web_request.py`, `web_response.py` - Server framework
- **WebSocket**: `_websocket/` - Dedicated subpackage for WebSocket protocol handling
- **HTTP Layer**: `connector.py` - Connection pooling and management; `multipart.py` - Multipart form handling
- **Performance**: `_http_parser.pyx` / `_http_writer.pyx` - Cython-optimized HTTP parsing/writing
- **Headers**: `hdrs.py`, `_find_header.c` - Header constants and fast lookup (auto-generated)

### Vendor Code

- `vendor/llhttp/` - Vendored low-level HTTP parser (regenerated via `make generate-llhttp`)

### Tests

- `tests/` - Organized by component (e.g., `test_client*.py`, `test_web_*.py`, `test_ws_*.py`)

## Coding Standards

- **Typing**: Strict mypy configuration (`.mypy.ini`). All code must be fully type-annotated
- **Formatting**: `black` for code, `isort` for imports (via pre-commit)
- **Async**: Use `async/await` patterns; avoid blocking calls
- **Changelog**: Use `towncrier` for changelog entries. Create fragment files in `CHANGES/` named `<issue_number>.<type>` where type is: `bugfix`, `feature`, `deprecation`, `breaking`, `doc`, `packaging`, `contrib`, or `misc`

## Key Files

- `Makefile` - Primary interface for development tasks
- `pyproject.toml` - Project metadata and tool configuration
- `.mypy.ini` - Strict type-checking rules
- `.pre-commit-config.yaml` - Pre-commit hooks for formatting/linting

## Cython Extensions

Performance-critical code is in `.pyx` files. After modifying:
1. Cython extensions are compiled via `make develop` or `make cythonize`
2. Headers (`hdrs.py`, `_headers.pyi`) are auto-generated by `tools/gen.py`
3. Rebuild with: `make cythonize && pip install -e .`