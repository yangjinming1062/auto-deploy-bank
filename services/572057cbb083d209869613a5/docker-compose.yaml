services:
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: graphscope-coordinator
    ports:
      - "42441:8080"  # Map HTTP service port 8080 to host port 42441
      - "63800:63800"  # Map gRPC service port
    environment:
      # Core environment variables
      - GRAPHSCOPE_HOME=/opt/graphscope
      - GRAPHSCOPE_DEBUG=false
      - GRAPHSCOPE_RUNTIME=~/.graphscope/runtime/coordinator
      - GSCONFIG=~/.gsctl
      - GS_GRPC_CHUNK_SIZE=268435455
      - VINEYARD_USE_LOCAL_REGISTRY=TRUE
      - WITHOUT_LEARNING_ENGINE=
      - PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
      - GRPC_ENABLE_FORK_SUPPORT=false

      # Kubernetes and cluster configuration
      - KUBECONFIG=~/.kube/config
      - KUBE_API_ADDRESS=
      - COORDINATOR_ENDPOINT=
      - GROOT_USERNAME=
      - GROOT_PASSWORD=
      - SOLUTION=GRAPHSCOPE_ONE
      - CLUSTER_TYPE=HOSTS
      - NAMESPACE=kubetask
      - INSTANCE_NAME=demo

    volumes:
      - ./config.yaml:/app/config.yaml
      - ./coordinator.config:/app/coordinator.config
      - ./groot.config:/app/groot.config

    # Resource limits to prevent consuming all system resources
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped
    networks:
      - graphscope-network

  # Vineyard service (distributed in-memory data store)
  vineyard:
    image: vineyardcloudnative/vineyardd:latest
    container_name: graphscope-vineyard
    ports:
      - "9600:9600"  # Vineyard RPC port
    environment:
      - VINEYARD_UID=vineyard
      - VINEYARD_GID=vineyard
    volumes:
      - vineyard-data:/var/vineyard
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - graphscope-network

  # Zookeeper (for Groot/Interactive Engine coordination)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: graphscope-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped
    networks:
      - graphscope-network

  # Kafka (for Groot/Interactive Engine message passing)
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: graphscope-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    volumes:
      - kafka-data:/var/lib/kafka/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    networks:
      - graphscope-network

volumes:
  vineyard-data:
    driver: local
  zookeeper-data:
    driver: local
  zookeeper-logs:
    driver: local
  kafka-data:
    driver: local

networks:
  graphscope-network:
    driver: bridge