services:
  verl:
    build:
      context: .
      dockerfile: Dockerfile
    image: verl-ray-vllm:latest
    container_name: verl-ray-service
    ports:
      - "40751:40751"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - RANK=${RANK:-0}
      - WORLD_SIZE=${WORLD_SIZE:-1}
      - LOCAL_RANK=${LOCAL_RANK:-0}
      - LOCAL_WORLD_SIZE=${LOCAL_WORLD_SIZE:-1}
      - MASTER_ADDR=${MASTER_ADDR:-localhost}
      - MASTER_PORT=${MASTER_PORT:-29500}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - MY_HOST_IP=${MY_HOST_IP:-}
      - MY_HOST_IPV6=${MY_HOST_IPV6:-}
      - VIDEO_MAX_PIXELS=${VIDEO_MAX_PIXELS:-128000*28*28*0.9}
      - VIDEO_TOTAL_PIXELS=${VIDEO_TOTAL_PIXELS:-128000*28*28*0.9}
      - TORCHCODEC_NUM_THREADS=${TORCHCODEC_NUM_THREADS:-8}
      - USE_MODELSCOPE_HUB=${USE_MODELSCOPE_HUB:-0}
      - TOKENIZERS_PARALLELISM=${TOKENIZERS_PARALLELISM:-true}
      - NCCL_DEBUG=${NCCL_DEBUG:-WARN}
      - VLLM_LOGGING_LEVEL=${VLLM_LOGGING_LEVEL:-WARN}
      - VLLM_WORKER_MULTIPROC_METHOD=${VLLM_WORKER_MULTIPROC_METHOD:-spawn}
      - TORCH_NCCL_AVOID_RECORD_STREAMS=${TORCH_NCCL_AVOID_RECORD_STREAMS:-1}
      - PYTORCH_CUDA_ALLOC_CONF=${PYTORCH_CUDA_ALLOC_CONF:-expandable_segments:False}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FLASH_ATTENTION_DETERMINISTIC=${FLASH_ATTENTION_DETERMINISTIC:-0}
      - SWANLAB_API_KEY=${SWANLAB_API_KEY:-}
      - SWANLAB_DIR=${SWANLAB_DIR:-swanlab_log}
      - SWANLAB_MODE=${SWANLAB_MODE:-cloud}
      - TENSORBOARD_DIR=${TENSORBOARD_DIR:-tensorboard_log}
      - DISABLE_WORKER_INIT=${DISABLE_WORKER_INIT:-0}
      - FORCE_QWENVL_VIDEO_READER=${FORCE_QWENVL_VIDEO_READER:-}
      - DEBUG_MODE=${DEBUG_MODE:-}
      - LOG_PATH=${LOG_PATH:-}
      - ROCR_VISIBLE_DEVICES=${ROCR_VISIBLE_DEVICES:-}
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 1G
    volumes:
      - ./:/home/ubuntu/deploy-projects/49b65a14bc2b017e325149f2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:40751/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped