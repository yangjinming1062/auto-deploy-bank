version: '3.8'

services:
  pc-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pc-agent-service
    ports:
      - "40513:40513"
    environment:
      # API Keys (set these in .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-your_openai_api_key_here}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-your_gemini_api_key_here}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-your_claude_api_key_here}
      - QWEN_API_KEY=${QWEN_API_KEY:-your_qwen_api_key_here}
      - BACKBONE_TYPE=${BACKBONE_TYPE:-OpenAI}

      # OCR Configuration (Optional)
      - OCR_ACCESS_KEY_ID=${OCR_ACCESS_KEY_ID:-your_ocr_access_key_id}
      - OCR_ACCESS_KEY_SECRET=${OCR_ACCESS_KEY_SECRET:-your_ocr_access_key_secret}
      - OCR_SERVER_ADDRESS=${OCR_SERVER_ADDRESS:-your_ocr_server_address}

      # PC-Agent Configuration
      - ADB_PATH=/path/to/adb
      - GCP_API_KEY=${GCP_API_KEY:-your_gcp_api_key_here}

      # Alibaba Cloud OSS (for Mobile-Agent-v3)
      - access_key_id=${access_key_id:-your_oss_access_key_id}
      - access_key_secret=${access_key_secret:-your_oss_access_key_secret}
      - endpoint=${endpoint:-your_oss_endpoint}
      - bucket_name=${bucket_name:-your_oss_bucket_name}
      - url_prefix=${url_prefix:-your_oss_url_prefix}

      # Distributed Training (UI-S1)
      - MASTER_ADDR=${MASTER_ADDR:-localhost}
      - MASTER_PORT=${MASTER_PORT:-29500}
      - RANK=${RANK:-0}
      - LOCAL_RANK=${LOCAL_RANK:-0}
      - WORLD_SIZE=${WORLD_SIZE:-1}
      - NCCL_DEBUG=${NCCL_DEBUG:-WARN}
      - TOKENIZERS_PARALLELISM=${TOKENIZERS_PARALLELISM:-false}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}

      # ML Tracking
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-your_mlflow_tracking_uri}
      - WANDB_API_KEY=${WANDB_API_KEY:-your_wandb_api_key}
      - SWANLAB_API_KEY=${SWANLAB_API_KEY:-your_swanlab_api_key}
      - SWANLAB_LOG_DIR=${SWANLAB_LOG_DIR:-swanlog}
      - SWANLAB_MODE=${SWANLAB_MODE:-cloud}

      # Volcano Engine
      - VOLC_ACCESS_KEY_ID=${VOLC_ACCESS_KEY_ID:-your_volc_access_key}
      - VOLC_SECRET_ACCESS_KEY=${VOLC_SECRET_ACCESS_KEY:-your_volc_secret_key}

      # VERL Framework
      - VERL_VLLM_USE_RAY_BACKEND=${VERL_VLLM_USE_RAY_BACKEND:-1}
      - VERL_ENABLE_TRACKER=${VERL_ENABLE_TRACKER:-0}

      # Feature Flags
      - ADD_REFLECTION=${ADD_REFLECTION:-1}
      - ADD_INFO=${ADD_INFO:-}
      - ADD_GENERAL_ADD_INFO=${ADD_GENERAL_ADD_INFO:-}

      # Performance Tuning
      - FLASH_ATTENTION_DETERMINISTIC=${FLASH_ATTENTION_DETERMINISTIC:-0}
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-1}
      - CUDA_DEVICE_MAX_CONNECTIONS=${CUDA_DEVICE_MAX_CONNECTIONS:-4}
      - CUDA_MODULE_LOADING=${CUDA_MODULE_LOADING:-AUTO}

      # gRPC Settings
      - GRPC_VERBOSITY=${GRPC_VERBOSITY:-ERROR}
      - GRPC_TRACE=${GRPC_TRACE:-none}

      # Display Settings for headless GUI
      - DISPLAY=:99
      - QT_QPA_PLATFORM=offscreen

      # Python Environment
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app

    volumes:
      # Mount volumes for task outputs and screenshots
      - ./task_data:/app/task_data
      - ./temp:/app/temp
      - ./logs:/app/logs

    # Configure restart policy
    restart: unless-stopped

    # Configure health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:40513/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (required)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Security options (optional)
    security_opt:
      - seccomp:unconfined

    # Network mode
    network_mode: bridge

# Volume definitions
volumes:
  task_data:
    driver: local
  temp:
    driver: local
  logs:
    driver: local