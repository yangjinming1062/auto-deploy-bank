# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```sh
# Install dependencies
npm install

# Build the library (generates dist/ folder)
npm run build

# Run all tests (builds first, then runs browser + node tests)
npm run test

# Run only unit tests (browser-based with Karma)
npm run test-unit

# Run Node.js specific tests
npm run test-node

# Run deployment tests for all module formats (ES, UMD, AMD, globals, TypeScript, webworker)
npm run test-local

# Run CI tests (headless Chrome, coverage, CodeClimate)
npm run test-ci

# Check TypeScript typings
npm run test-typings

# Check code formatting
npm run lint

# Auto-format code
npm run prettier

# Generate JSDoc documentation
npm run generate-docs

# Start local dev server (localhost:8000)
npm start
```

## Architecture

jsPDF is a JavaScript library for generating PDF documents. The codebase is organized as follows:

### Source Structure
- **`src/jspdf.js`** - Core PDF generation engine containing the main `jsPDF` class, page management, coordinate systems, and low-level PDF operators
- **`src/index.js`** - Entry point that exports the public API and imports all feature modules
- **`src/modules/`** - Feature modules that extend the core jsPDF class (each file adds methods via prototype extension)
  - Key modules: `addimage.js`, `html.js`, `cell.js`, `context2d.js`, `acroform.js`, `ttfsupport.js`, `utf8.js`
  - Image support: `png_support.js`, `jpeg_support.js`, `gif_support.js`, `bmp_support.js`, `webp_support.js`
- **`src/libs/`** - Internal utility libraries
  - `FileSaver.js` - File saving functionality
  - `ttffont.js` - TTF font parsing and embedding
  - `bidiEngine.js` - Bidirectional text support
  - `pdfsecurity.js` - PDF encryption and permissions

### Build System
- **Rollup** bundles source into three formats:
  - ES modules (`dist/jspdf.es.min.js`)
  - UMD for browsers (`dist/jspdf.umd.min.js`)
  - CommonJS for Node.js (`dist/jspdf.node.min.js`)
- **Babel** transpiles for target environments (configured per format in `rollup.config.js`)
- Polyfills are bundled separately (`dist/polyfills.es.js`, `dist/polyfills.umd.js`)

### API Modes
jsPDF supports two API modes:
- **"compat" mode** (default) - Backward-compatible API from original jsPDF
- **"advanced" mode** - Full API with patterns, FormObjects, transformation matrices

Switch modes using:
```javascript
doc.advancedAPI((doc) => { /* advanced features */ });
doc.compatAPI((doc) => { /* compat features */ });
```

### Testing
- **Unit tests** (`test/unit/`) - Browser-based Karma tests for core functionality
- **Deployment tests** (`test/deployment/`) - Tests for each module format (ES, UMD, AMD, globals, TypeScript, webworker)
- **Reference PDFs** (`test/reference/`) - Baseline PDF files for visual regression testing
- **Node tests** (`test/deployment/node/`) - Server-side PDF generation tests

### TypeScript
- Type definitions in `types/index.d.ts` must be updated when adding new API surface
- Run `npm run test-typings` to validate TypeScript compatibility

## Key Conventions

- New features are implemented as modules in `src/modules/` and imported in `src/index.js`
- When adding new APIs, update `types/index.d.ts` for TypeScript support
- Use modern JavaScript (ES6+) - the build process handles transpilation
- Polyfills for new browser APIs should be added to `src/polyfills.js`
- Reference PDFs can be regenerated by running `npm run test-training` in the background