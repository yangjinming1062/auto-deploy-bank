# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Robolectric** project - an industry-standard unit testing framework for Android. Robolectric enables Android unit tests to run in a simulated Android environment inside the JVM, without emulators. Tests run 10x faster than on cold-started emulators.

**Key Facts:**
- Current version: 4.17-SNAPSHOT (defined in `gradle.properties`)
- Supports Android API levels 23-36 (Marshmallow to Baklava)
- Primary development occurs in both GitHub (public) and internal Google repos
- Built with **Gradle 9.2.1** using Kotlin DSL (`build.gradle.kts`)
- Java 17+ required (Launcher JVM: 17.0.17)

## Build System Requirements

### Prerequisites

```bash
# Required: Android SDK must be set
export ANDROID_HOME=/path/to/android-sdk

# Recommended: Use gradlew wrapper (already configured)
./gradlew
```

### Common Build Commands

```bash
# Build all modules
./gradlew assemble

# Build and compile test classes
./gradlew assemble testClasses

# Run all tests (requires ANDROID_HOME)
./gradlew test

# Run tests for specific Android API levels
./gradlew test -Drobolectric.enabledSdks=23,24,25

# Run a single test
./gradlew test --tests "com.example.MyTestClass"

# Run tests with stacktrace on failure
./gradlew test --stacktrace

# Run tests and continue on failure (don't stop at first failure)
./gradlew test --continue

# Run connected Android instrumentation tests (on emulator)
./gradlew cAT

# Format Java code (Google Java Format)
./gradlew spotlessApply

# Check Kotlin code style
./gradlew spotlessCheck

# Run detekt (Kotlin static analysis)
./gradlew detekt

# Generate Javadoc for all modules
./gradlew aggregateJavadocs

# Publish to Sonatype snapshots (requires credentials)
./gradlew publish
```

**Environment variables for CI/testing:**
```bash
# Skip error-prone checks (used in CI)
SKIP_ERRORPRONE=true

# Skip Javadoc generation (used in CI)
SKIP_JAVADOC=true

# Limit Gradle workers for parallel execution
./gradlew test -Dorg.gradle.workers.max=2
```

## Architecture

### Module Structure

**Core Modules:**
- `:robolectric` - Main Robolectric testing framework API and runtime
- `:shadows:framework` - Shadow implementations for Android framework classes
- `:shadows:httpclient` - Shadow implementations for Apache HTTP client
- `:annotations` - Robolectric annotations (`@Config`, `@Implements`, `@RunWith`, etc.)
- `:processor` - Annotation processor for generating shadow classes
- `:resources` - Android resource loading and management
- `:sandbox` - Security sandbox for running tests in isolated environment
- `:nativeruntime` - Native code runtime for Android native methods
- `:pluginapi` - Plugin API for extending Robolectric
- `:utils` - Utility classes used across modules
- `:utils:reflector` - Reflection utilities

**Test Modules:**
- `:integration_tests` - Various integration test submodules for third-party libraries
  - `:androidx`, `:androidx_test`, `:composeui`
  - `:kotlin`, `:mockito`, `:mockk`, `:room`, etc.
- `:testapp` - Sample Android application for testing
- `:jun
it` - JUnit integration support

**Build Modules:**
- `:buildSrc` - Gradle build logic and plugins
  - `AndroidSdk.kt` - Defines supported Android SDK versions (API 23-36)
  - Custom Gradle plugins for module configuration

### Key Components

**Android SDK Management** (`buildSrc/src/main/java/AndroidSdk.kt`):
- Defines 14 supported Android versions from Marshmallow (API 23) to Baklava (API 36)
- Each SDK has coordinates for pre-instrumented artifacts
- Managed via Maven dependencies

**Shadow System**:
- Shadow classes provide mock implementations of Android framework classes
- Generated by annotation processor from `:processor`
- Located in `:shadows:framework` and other shadow modules
- Used to simulate Android behavior in JVM tests

**Test Execution**:
- Tests run in sandboxed environment with security manager
- Supports multiple Android SDK versions via config
- Native code loaded via `:nativeruntime`

## Code Style

### Java Style
- **Google Java Style** with 2-space indents
- Use `google-java-format` to format (version 1.32.0)
- CI checks: `check_code_style.yml` workflow
- Curly braces for everything (`if`, `else`, etc.)
- No `'m'` or `'s'` prefixes for variables
- One blank line between methods

### Kotlin Style
- **Spotless + ktfmt** with Google's style
- Check with: `./gradlew spotlessCheck`
- Fix with: `./gradlew spotlessApply`
- Also enforced via Detekt: `./gradlew detekt`

### Testing Requirements
- All public methods must have unit tests
- Use JUnit's `assertThrows` for exception testing (not `@Test(expected=...)`)
- Shadow methods with behavior differences **must** have Javadoc explaining the variance
- Use `@see` or `@link` to reference testing API methods

### Documentation
- Javadoc is auto-generated and published to https://robolectric.org/
- Run `./gradlew aggregateJavadocs` to generate locally
- Javadoc source compatibility set to JDK 8 (see `build.gradle.kts:119`)

## Development Workflow

### Environment Setup

1. **Install Android SDK** and set `ANDROID_HOME`
2. **Clone repository**: `git clone https://github.com/robolectric/robolectric.git`
3. **Import into IDE**: Open `build.gradle.kts` in IntelliJ/Android Studio
4. **Build project**: `./gradlew assemble`

### Contributing Changes

1. Create feature branch: `git checkout -b my-feature-name`
2. Make changes with tests
3. Format code: `./gradlew spotlessApply`
4. Run tests: `./gradlew test`
5. Squash commits into single commit for PR
6. Submit PR to `master` branch

**PR Requirements:**
- Single commit with title and body
- Commit message lines < 120 characters
- All CI checks must pass
- Code style enforced automatically

### Android SDK Resources

Scripts in `/scripts/` directory for building Android SDK resources:

- `build-android.sh` - Build android-all.jar from AOSP source
- `sync-android.sh` - Sync Android source repository
- `install-android-prebuilt.sh` - Install prebuilt SDK artifacts

See `scripts/README.md` for detailed instructions (requires ~100GB space).

## CI/CD

### GitHub Actions Workflows (`.github/workflows/`)

- `tests.yml` - Main test suite
  - Unit tests across 5 API version groups (23-36)
  - Instrumentation tests on API 30, 36 with emulator
  - Runs on ubuntu-latest

- `check_code_style.yml` - Code style enforcement
  - Google Java Format checker
  - Spotless Kotlin formatter check
  - Detekt static analysis

- `codeql.yml` - CodeQL security analysis
- `graphics_tests.yml` - Graphics-specific test suite
- `sync_google_master.yml` - Sync internal Google changes to master

### Test Matrix
Unit tests run in 5 parallel groups by API level:
- Group 1: API 23, 24, 25
- Group 2: API 26, 27, 28
- Group 3: API 29, 30, 31
- Group 4: API 32, 33, 34
- Group 5: API 35, 36

## Configuration Files

- `gradle.properties` - Project-wide Gradle configuration
- `settings.gradle.kts` - Module inclusion and repository configuration
- `build.gradle.kts` - Root build configuration
- `.java-version` - JDK version for CI (Java 17)
- `WORKSPACE` - Bazel build file (for internal builds)

**Key Gradle Properties:**
- `thisVersion=4.17-SNAPSHOT` - Version number
- `org.gradle.caching=true` - Build cache enabled
- `org.gradle.jvmargs=-Xmx2g` - Increased heap size
- `org.gradle.parallel=true` - Parallel execution

## Development Notes

- **Build cache enabled** - Subsequent builds will be faster
- **Incremental annotation processing** - Only affected shadows are regenerated
- **Multi-SDK testing** - Tests can target specific SDK versions via config
- **Security sandbox** - Tests run with restricted permissions
- **Snapshot publishing** - Auto-published to Sonatype from `master` branch

## Architecture References

High-level architecture documentation: https://robolectric.org/architecture
Building guide: https://robolectric.org/building-robolectric/