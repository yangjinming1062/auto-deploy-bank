services:
  redis:
    image: redis:4.0
    restart: always
    container_name: skyline-redis
    hostname: skyline-redis
    command: redis-server --appendonly yes
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    networks:
      - skylinenetwork
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql:
    image: mysql:5.7
    restart: always
    container_name: skyline-mysql
    hostname: skyline-mysql
    expose:
      - "3306"
    environment:
      MYSQL_ROOT_PASSWORD: ''
      MYSQL_ALLOW_EMPTY_PASSWORD: 'true'
      MYSQL_DATABASE: skyline
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - skylinenetwork
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  memcached:
    image: memcached:latest
    restart: always
    container_name: skyline-memcached
    hostname: skyline-memcached
    expose:
      - "11211"
    networks:
      - skylinenetwork
    healthcheck:
      test: ["CMD", "echo", "stats settings", "|", "nc", "localhost", "11211"]
      interval: 10s
      timeout: 5s
      retries: 5

  graphite-statsd:
    image: graphiteapp/graphite-statsd:latest
    restart: always
    container_name: skyline-graphite-statsd
    hostname: skyline-graphite-statsd
    expose:
      - "80"
      - "2003"
      - "2024"
      - "8125"
    environment:
      RELAY: 1
    volumes:
      - graphite_data:/opt/graphite/storage
      - graphite_logs:/var/log
    networks:
      - skylinenetwork
    depends_on:
      - memcached
    healthcheck:
      test: ["CMD", "netstat", "-tuln", "|", "grep", ":80"]
      interval: 30s
      timeout: 10s
      retries: 5

  webapp:
    build: .
    restart: always
    container_name: skyline-webapp
    hostname: skyline-webapp
    expose:
      - "1500"
    ports:
      - "41723:1500"
    environment:
      GEVENT_MONKEYLIB_PLUGINS: ""
      GEVENT_NO_PLUGINS: "1"
      REDIS_SOCKET_PATH: /tmp/redis.sock
      SECRET_KEY: 'your-long_secret-key-to-encrypt_the_redis_password_in_url_parameters'
      LOG_PATH: /var/log/skyline
      PID_PATH: /var/run/skyline
      SKYLINE_DIR: /opt/skyline
      SKYLINE_TMP_DIR: /tmp/skyline
      FULL_NAMESPACE: 'metrics.'
      GRAPHITE_HOST: graphite-statsd
      GRAPHITE_PROTOCOL: http
      GRAPHITE_PORT: '80'
      CARBON_HOST: graphite-statsd
      CARBON_PORT: 2003
      SERVER_METRICS_NAME: skyline-webapp
      PANORAMA_DATABASE: skyline
      PANORAMA_DBHOST: mysql
      PANORAMA_DBPORT: '3306'
      PANORAMA_DBUSER: root
      PANORAMA_DBUSERPASS: ''
      WEBAPP_AUTH_ENABLED: false
      WEBAPP_IP: 0.0.0.0
      WEBAPP_IP_RESTRICTED: false
      FULL_DURATION: 86400
      MINI_DURATION: 3600
      # Internal service addresses
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MEMCACHED_SERVER_IP: memcached
      MEMCACHED_SERVER_PORT: 11211
    volumes:
      - webapp_logs:/var/log/skyline
      - webapp_tmp:/tmp/skyline
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      memcached:
        condition: service_healthy
      graphite-statsd:
        condition: service_healthy
    networks:
      - skylinenetwork
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1500/"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

volumes:
  redis_data:
  mysql_data:
  graphite_data:
  graphite_logs:
  webapp_logs:
  webapp_tmp:

networks:
  skylinenetwork:
    driver: bridge