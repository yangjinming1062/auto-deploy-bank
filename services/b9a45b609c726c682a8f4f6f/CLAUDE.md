# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

jsonpath is a Node.js library for querying JavaScript objects with JSONPath expressions. It implements a safe, robust JSONPath engine compatible with Stefan Goessner's original implementation, but uses a formal BNF grammar (via Jison) rather than regex parsing, and uses `static-eval` for safe script expression evaluation.

## Commands

```bash
# Run tests and linting
npm test

# Run only tests
mocha -u tdd test

# Run a single test file
mocha -u tdd test/query.js

# Generate parser from grammar (Jison)
npm run generate

# Build browser bundle (jsonpath.js + jsonpath.min.js)
grunt
```

## Architecture

The library follows a parser-handler pattern:

- **`lib/index.js`** - Main `JSONPath` class and public API (`query`, `paths`, `nodes`, `value`, `parent`, `apply`, `parse`, `stringify`). Handles path normalization, safety checks (`__proto__`, `prototype`, `constructor` blocking), and orchestrates the parser and handlers.

- **`lib/grammar.js`** - Jison grammar definition for JSONPath syntax. Defines lex rules and BNF productions. Output is an array of path components with `expression`, `operation`, and `scope` properties.

- **`lib/parser.js`** - Generated by Jison from `grammar.js`. Do not edit manually; regenerate with `npm run generate`.

- **`lib/handlers.js`** - Resolves path components to traverse and filter data. Each handler implements a specific operation (child/descendant member, subscript, wildcard, union, slice, filter expression).

- **`lib/dict.js`** - Regex patterns (identifiers, strings, integers) used by the lexer.

- **`lib/slice.js`** - ES4/Python-style array slice operator `[start:end:step]` implementation.

- **`lib/aesprim.js`** - Monkey-patches esprima to recognize `@` as a valid identifier start character, required for script expressions like `?(...)` and `(...)`.

**Traversal Flow:**
1. Parse JSONPath string â†’ AST via `Parser`
2. For each path component, resolve its `Handler`
3. Handler processes current partial results, returns new matches or partials
4. Final matches returned as `{path: [...], value: ...}` nodes

## Code Style

- 2-space indentation
- Strict style enforced by JSHint and JSCS
- No spaces before opening parentheses in function expressions/declarations
- No yoda conditions
- Requires parentheses around IIFE
- `self` as safe context keyword

## Browser Build

Browser bundle uses `aesprim-browser.js` instead of `aesprim.js` (aliased in `package.json`). The bundle process:
1. Browserify bundles `index.js` with alias for aesprim
2. Post-bundle callback patches esprima source to support `@` character
3. Uglify produces minified version

Generated files: `jsonpath.js` (browser global `jsonpath`) and `jsonpath.min.js`.