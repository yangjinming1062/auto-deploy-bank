# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**知路后台管理** (ZhiLu Admin) - An AI-driven admin scaffold built with Vue 3.5 + Java 21. Features native AI integration via LangChain4j, cloud-native deployment with Docker, and comprehensive test coverage with TDD practices.

## Commands

### Backend (Java 21, Spring Boot 3.3.9, Gradle)

```bash
cd backend

# Build and test
./gradlew build                    # Build project (includes tests)
./gradlew test                     # Run all tests with JaCoCo report
./gradlew test --tests "ClassName" # Run specific test class
./gradlew test --tests "*MethodName"  # Run specific test method

# Code quality
./gradlew spotlessApply            # Format code (Google Java Format)
./gradlew pmd                      # Run PMD static analysis

# Database and code generation
./gradlew jooqCodegen              # Generate JOOQ DAOs from Flyway migrations
./gradlew bootRun                  # Run application locally
```

### Frontend (Vue 3.5, Vite 6, TypeScript)

```bash
cd frontend

# Development
npm run dev                        # Start dev server (port 5173)
npm run build                      # Build for production
npm run preview                    # Preview production build

# Code quality
npm run format                     # Format with Biome
npm run lint                       # Lint with Biome
npm run check                      # Biome format + lint (use before commit)

# Testing
npm run test:unit                  # Run unit tests with Vitest
npm run test:e2e                   # Run e2e tests with Playwright
npm run test:ts                    # TypeScript type check

# API
npm run generate:api               # Generate TypeScript types from OpenAPI spec
```

## Architecture

### Backend Structure

```
backend/src/main/java/com/zl/mjga/
├── ApplicationService.java        # Main @SpringBootApplication class
├── aspect/LoggingAspect.java      # HTTP request/response logging AOP
├── config/                        # Configuration classes
│   ├── ai/                        # LangChain4j AI setup (DeepSeek, ZhiPu)
│   ├── cache/CacheConfig.java     # Caffeine cache configuration
│   ├── minio/MinIoConfig.java     # Object storage config
│   └── security/                  # Security configuration
├── controller/                    # REST API endpoints
├── dto/                           # Data transfer objects
├── model/urp/                     # User-Role-Permission domain models
├── repository/                    # Custom repositories
├── service/                       # Business logic layer
└── utils/                         # Utility classes
```

- **Database**: PostgreSQL with Flyway migrations in `src/main/resources/db/migration/`
- **ORM**: JOOQ generates DAOs and records from migrations into `org.jooq.generated` package
- **Security**: Spring Security with JWT authentication (java-jwt)
- **AI**: LangChain4j integration with DeepSeek and ZhiPu AI models, PGVector for knowledge base
- **Scheduling**: Spring Quartz for scheduled tasks

### Frontend Structure

```
frontend/src/
├── api/
│   ├── schema/openapi.json        # OpenAPI spec (auto-generated by backend)
│   ├── types/schema.d.ts          # Generated TypeScript types
│   └── mocks/                     # MSW handlers for API mocking
├── components/
│   ├── layout/                    # Dashboard, Sidebar, Headbar
│   ├── modals/                    # Form dialogs (UserFormDialog, etc.)
│   ├── tables/                    # Reusable table components
│   └── ui/                        # Base UI components (Button, Avatar)
├── composables/                   # Pinia stores and composables
│   ├── store/                     # Pinia stores
│   ├── auth/                      # Authentication composable
│   ├── permission/                # RBAC permission logic
│   └── ai/                        # AI chat and knowledge base
├── router/
│   ├── index.ts                   # Router setup with guards
│   ├── guards.ts                  # Auth and permission guards
│   └── modules/                   # Route modules (user.ts, ai.ts, etc.)
├── views/                         # Page components (per feature)
└── assets/                        # CSS and static assets
```

- **State Management**: Pinia stores in `composables/store/` and feature composables
- **API Client**: openapi-fetch with generated types from OpenAPI spec
- **Mocking**: MSW (Mock Service Worker) for development/testing
- **Styling**: Tailwind CSS v4 with tab indentation
- **Linting**: Biome with specific rules in `biome.json` (Vue files excluded from some rules)

### Data Model

**User-Role-Permission (URP)** with support for:
- Users belonging to multiple roles
- Users belonging to multiple departments
- Users holding multiple positions
- Roles having multiple permissions
- Departments forming a tree structure with parent_id

## Configuration

### Environment Variables (Backend)

Configured in `application.yml` via `${VAR}` placeholders:
- `DATABASE_HOST_PORT`, `DATABASE_DB`, `DATABASE_USER`, `DATABASE_PASSWORD`
- `JWT_SECRET`, `JWT_EXPIRATION_MIN`
- `ALLOWED_ORIGINS`, `ALLOWED_METHODS`, `ALLOWED_HEADERS`
- `MINIO_ENDPOINT`, `MINIO_ROOT_USER`, `MINIO_ROOT_PASSWORD`
- `MINIO_DEFAULT_BUCKETS`

### Database Migrations

Flyway migrations in `backend/src/main/resources/db/migration/`:
- `V1_0_0__init_table.sql` - Core tables (user, role, permission, department, position)
- `V1_0_1__insert_init_table.sql` - Initial data
- `V1_0_2__init_quartz.sql` - Quartz scheduler tables
- `V1_0_3__init_library.sql` - AI knowledge base tables
- `V1_0_4__init_aop_log.sql` - AOP logging tables

## Code Style

### Backend
- Java 21 with Google Java Format (via Spotless)
- PMD rules configured in `pmd-rules.xml` (bestpractices, errorprone categories)
- JOOQ generates DAOs with Spring annotations

### Frontend
- Biome formatting with tab indentation
- Double quotes for JavaScript
- TypeScript strict mode with vue-tsc
- `.vue` files exempt from `useConst` and `useImportType` rules

## Key Conventions

- Backend tests follow TDD pattern with unit, integration, and e2e tests in `src/test/java/`
- Frontend API types generated from backend OpenAPI spec (regenerate after backend changes)
- MSW mocks match backend API structure in `src/api/mocks/handlers/`
- JWT tokens for authentication; logging aspect captures all HTTP requests