services:
  postgresql:
    image: postgres:16-alpine
    container_name: lifephoton-postgres
    environment:
      POSTGRES_DB: lifephoton
      POSTGRES_USER: root
      POSTGRES_PASSWORD: "123456"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/create_test_accounts.sh:/docker-entrypoint-initdb.d/create_test_accounts.sh
    networks:
      - lifephoton-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d lifephoton"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  lifephoton:
    build:
      context: .
      dockerfile: Dockerfile
      no_cache: true
    container_name: lifephoton-app
    ports:
      - "40305:808"
    environment:
      DB_HOST: postgresql
      DB_NAME: lifephoton
      DB_USER: root
      DB_PASS: "123456"
      EMAIL_URL: smtp.example.com
      EMAIL_PORT: "465"
      EMAIL_USERNAME: your-email@example.com
      EMAIL_PASSWORD: your-email-password
      APP_HOST: "0.0.0.0"
      APP_PORT: "808"
    volumes:
      - ./target.jar:/home/app/app.jar
      - ./data/LifePhoton/prop/lifephoton.properties:/data/LifePhoton/prop/lifephoton.properties:ro
    networks:
      - lifephoton-network
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:808/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

networks:
  lifephoton-network:
    driver: bridge

volumes:
  postgres_data: