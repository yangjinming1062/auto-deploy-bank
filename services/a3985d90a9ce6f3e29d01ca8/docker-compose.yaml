services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    expose:
      - 6333
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__LOG_LEVEL: "INFO"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  indexer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ${LOCAL_FILES_PATH:-./local_files}:/usr/src/app/local_files/
      - indexer_data:/indexer/storage
    ports:
      - "40458:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - LOCAL_FILES_PATH=/usr/src/app/local_files/
      - EMBEDDING_MODEL_ID=${EMBEDDING_MODEL_ID:-BAAI/bge-small-en-v1.5}
      - EMBEDDING_SIZE=${EMBEDDING_SIZE:-384}
      - CONTAINER_PATH=/usr/src/app/local_files/
      - QDRANT_BOOTSTRAP=qdrant
    depends_on:
      qdrant:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/indexer/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  qdrant_data:
  indexer_data: