services:
  kogito-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kogito-service
    ports:
      - "40589:8080"
    environment:
      # Server Configuration
      - SERVER_PORT=8080
      - SPRING_APPLICATION_NAME=kogito-service
      - QUARKUS_HTTP_PORT=8080
      - QUARKUS_HTTP_HOST=0.0.0.0

      # Kogito REST Generation
      - KOGITO_GENERATE_REST=true

      # Security Configuration (OIDC/Keycloak)
      - KOGITO_SECURITY_AUTH_ENABLED=true
      - QUARKUS_OIDC_CLIENT_AUTH_SERVER_URL=http://localhost:8180/realms/kogito
      - QUARKUS_OIDC_CLIENT_CLIENT_ID=kogito-app
      - QUARKUS_OIDC_CLIENT_CREDENTIALS_CLIENT_SECRET=secret

      # Data Index Service (process instance management)
      - KOGITO_DATAINDEX_HTTP_URL=http://data-index:8180/dataindex
      - KOGITO_DATAINDEX_GRAPHQL_URL=ws://data-index:8180/dataindex/graphql

      # Jobs Service (async job scheduling)
      - KOGITO_JOBS_SERVICE_URL=http://jobs-service:8580/jobs

      # Persistence Configuration
      - KOGITO_PERSISTENCE_TYPE=jdbc
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:h2:mem:mydb
      - QUARKUS_DATASOURCE_USERNAME=sa
      - QUARKUS_DATASOURCE_PASSWORD=sa
      - QUARKUS_JPA_HIBERNATE_DATABASE_GENERATION=none

      # Kafka Configuration (event-driven processes)
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - QUARKUS_KAFKA_BOOTSTRAP_SERVERS=kafka:9092

      # Infinispan Configuration (caching)
      - INFINISPAN_CLIENT_SERVER_LIST=infinispan:11222
      - QUARKUS_INFINISPAN_CLIENT_SERVER_LIST=infinispan:11222

      # Logging Configuration
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_LOG_CATEGORY__ORG_KIE_KOGITO__LEVEL=DEBUG
      - QUARKUS_LOG_CATEGORY__ORG_DROOLS__LEVEL=INFO

      # JVM Configuration
      - JAVA_OPTS=-Xmx512m -Xms256m
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    # For security scanning, extract JAR using: docker cp kogito-service:/app/target.jar ./target.jar
    networks:
      - kogito-network
    depends_on:
      kafka:
        condition: service_started

  # Kafka for event-driven processes (internal only)
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    hostname: kafka
    ports:
      - "9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - kogito-network
    depends_on:
      zookeeper:
        condition: service_started

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - kogito-network

  # Data Index for process instance management (internal only)
  data-index:
    image: quay.io/kiegroup/kogito-data-index-postgresql:latest
    container_name: data-index
    hostname: data-index
    ports:
      - "8180"
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/kogito
      QUARKUS_DATASOURCE_USERNAME: kogito
      QUARKUS_DATASOURCE_PASSWORD: kogito
    networks:
      - kogito-network
    depends_on:
      postgres:
        condition: service_started

  # Jobs Service for async job scheduling (internal only)
  jobs-service:
    image: quay.io/kiegroup/kogito-jobs-service-postgresql:latest
    container_name: jobs-service
    hostname: jobs-service
    ports:
      - "8580"
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/kogito
      QUARKUS_DATASOURCE_USERNAME: kogito
      QUARKUS_DATASOURCE_PASSWORD: kogito
    networks:
      - kogito-network
    depends_on:
      postgres:
        condition: service_started

  # PostgreSQL database (internal only)
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    hostname: postgres
    environment:
      POSTGRES_DB: kogito
      POSTGRES_USER: kogito
      POSTGRES_PASSWORD: kogito
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - kogito-network

networks:
  kogito-network:
    driver: bridge

volumes:
  postgres_data: