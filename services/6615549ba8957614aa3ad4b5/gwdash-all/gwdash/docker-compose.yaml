version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:5.7
    container_name: gwdash-mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: gwdash
      MYSQL_USER: gwdash
      MYSQL_PASSWORD: password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./gwdash-server/src/main/resources/all.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis Cache
  redis:
    image: redis:6-alpine
    container_name: gwdash-redis
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Nacos Service Discovery
  nacos:
    image: nacos/nacos-server:v2.2.0
    container_name: gwdash-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_DB_NAME: nacos
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: password
      MYSQL_SERVICE_DB_PARAM: characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # RocketMQ NameServer
  rocketmq-nameserver:
    image: apache/rocketmq:4.9.4
    container_name: gwdash-rocketmq-nameserver
    command: ["sh", "mqnamesrv"]
    environment:
      JAVA_OPT_EXT: "-server -Xms512M -Xmx512M -Xmn256m"
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD", "ps", "-ef", "|", "grep", "mqnamesrv", "|", "grep", "-v", "grep"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # RocketMQ Broker
  rocketmq-broker:
    image: apache/rocketmq:4.9.4
    container_name: gwdash-rocketmq-broker
    command: ["sh", "mqbroker", "-c", "/home/rocketmq/rocketmq-4.9.4/conf/broker.conf"]
    environment:
      JAVA_OPT_EXT: "-server -Xms512M -Xmx512M -Xmn256m"
      NAMESRV_ADDR: "rocketmq-nameserver:9876"
    volumes:
      - ./rocketmq-broker.conf:/home/rocketmq/rocketmq-4.9.4/conf/broker.conf
    depends_on:
      - rocketmq-nameserver
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD", "ps", "-ef", "|", "grep", "mqbroker", "|", "grep", "-v", "grep"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # GwDash Server Application
  gwdash-server:
    build:
      context: /home/ubuntu/deploy-projects/6615549ba8957614aa3ad4b5
      dockerfile: gwdash-all/gwdash/gwdash-server/Dockerfile
    container_name: gwdash-server
    environment:
      # Server Configuration
      server.port: 8080
      server.context.path: /
      server.type: dev
      server.debug: true

      # Database Configuration
      spring.datasource.url: jdbc:mysql://mysql:3306/gwdash?characterEncoding=UTF-8
      spring.datasource.username: gwdash
      spring.datasource.password: password
      spring.datasource.driverClassName: com.mysql.jdbc.Driver

      # Redis Configuration
      spring.redis.host: redis
      spring.redis.port: 6379
      spring.redis.timeout: 30000
      spring.redis.cat.enabled: false

      # Nacos Configuration
      nacos.config.addrs: http://nacos:8848
      dubbo.registry.address: nacos://nacos:8848
      nacos.api.url: http://nacos:8848/nacos/v1/

      # Dubbo Configuration
      dubbo.group: local
      dubbo.protocol.port: 20880

      # RocketMQ Configuration
      rocketmq.namesrv.addr: rocketmq-nameserver:9876
      rocketmq.group: RocketMQResLocal
      rocketmq.topic: GwdashServerTopic

      # Logging
      logging.path: /tmp/log

      # Project Environment
      project.env.heap.ratio: 1
      use.file.server: true

    ports:
      - "40137:8080"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
    networks:
      - gwdash-network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    volumes:
      - ./target.jar:/app/target.jar

volumes:
  mysql_data:
    driver: local

networks:
  gwdash-network:
    driver: bridge