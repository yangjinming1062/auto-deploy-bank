#
# The MIT License (MIT)
#
# Copyright (c) 2019 Code Technology Studio
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of
# this software and associated documentation files (the "Software"), to deal in
# the Software without restriction, including without limitation the rights to
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
# the Software, and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
# FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
# IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#

services:
  jpom:
    build: .
    ports:
      - "40055:2122"
    environment:
      - JPOM_DB_URL=jdbc:mysql://mysql:3306/jpom?useUnicode=true&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true
      - JPOM_DB_USER_NAME=root
      - JPOM_DB_USER_PWD=k@4Qoi6qdV#OYjQd
      - JPOM_USER_TOKEN_JWT_KEY=a1b2c3d4e5f6g7h8
      - SERVER_PORT=2122
      - JPOM_DB_MODE=MYSQL
      - JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8
      - SPRING_HTTP_ENCODING_CHARSET=UTF-8
      - SPRING_HTTP_ENCODING_FORCE=true
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:2122"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - .:/export
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=k@4Qoi6qdV#OYjQd
      - MYSQL_DATABASE=jpom
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-uroot", "-pk@4Qoi6qdV#OYjQd"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  mysql-data:
