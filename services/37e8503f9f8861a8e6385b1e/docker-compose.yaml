services:
  train:
    build: .
    container_name: audio-classification-train
    volumes:
      - ./wavfiles:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/wavfiles
      - ./logs:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/logs
      - ./models:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/models
    command: sh -c "while true; do python train.py --src_root /home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/wavfiles; sleep 5; done"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  web:
    build: .
    container_name: audio-classification-web
    ports:
      - "5001:5000"
    volumes:
      - ./wavfiles:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/wavfiles
      - ./logs:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/logs
      - ./models:/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/models
    environment:
      - MODEL_PATH=/home/ubuntu/deploy-projects/37e8503f9f8861a8e6385b1e/models/lstm.h5
      - PORT=5000
    command: python app.py
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
