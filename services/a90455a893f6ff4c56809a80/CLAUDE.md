# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A simple Python voice assistant that enables conversational dialogue with a local large language model through voice. Voice recognition uses OpenAI's Whisper (Apple MLX implementation), and responses are generated by the Yi LLM from 01.AI.

## Commands

```bash
# Setup environment
conda create -n VoiceAI python=3.11
conda activate VoiceAI
pip install -r requirements.txt
CMAKE_ARGS="-DLLAMA_METAL=on" pip install llama-cpp-python

# Install audio processing (macOS)
brew install portaudio
pip install pyaudio

# Run the voice assistant
python main.py

# List available microphones (find correct MIC_IDX)
python tools/list_microphones.py
```

## Architecture

### Voice Input Pipeline
1. **Audio Recording** (`main.py:record_audio`): Records audio via PyAudio using silence detection (RMS threshold). Writes to `recordings/output.wav`
2. **Speech-to-Text** (`whisper/`): Apple's MLX Whisper implementation transcribes audio to text

### LLM Processing
- **Model**: Yi-34B-Chat or Yi-6B-Chat (GGUF format) via LangChain's LlamaCpp wrapper
- **Context**: 4096 tokens, streaming token-by-token with sentence-boundary detection
- **Prompt Template**: `prompts/example-en.txt` or `example-cn.txt` depending on `LANG` setting

### Voice Output Pipeline
- **TTS**: macOS `say` command with streaming (sentences queued as they're generated)
- **Voice**: TingTing (Chinese) or Karen (English)
- **Implementation**: `VoiceOutputCallbackHandler` uses a background thread to queue and speak sentences

### Key Configuration (main.py)
- `LANG`: "EN" or "CN" for language
- `MODEL_PATH`: Path to Yi GGUF model
- `WHISP_PATH`: Path to Whisper MLX model directory
- `MIC_IDX`: Microphone device index (find via tools/list_microphones.py)
- `SILENCE_THRESHOLD`: RMS threshold for voice activity detection

## Directory Structure

- `main.py`: Single-file application entry point (all logic)
- `whisper/`: Apple's MLX Whisper implementation for speech recognition
- `prompts/`: LLM prompt templates (English/Chinese)
- `tools/list_microphones.py`: Utility to discover microphone devices
- `models/`: Stores GGUF model files and Whisper model
- `recordings/`: Temporary audio recordings