version: '3'

services:

  spring-boot-init-template:
    image: spring-boot-init-template:v2.2.1-jdk17-pre
    container_name: spring-boot-init-template
    environment:
      # 时区上海
      TZ: Asia/Shanghai
      # 服务端口
      SERVER_PORT: 38080
      SERVER_SERVLET_CONTEXT_PATH: /api
      # 数据库配置
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/init_db?serverZoneId=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      DYNAMIC_DATASOURCE_DATASOURCE_NAMES: ds_master
      # Redis配置
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_DATABASE: 0
      SPRING_DATA_REDIS_PASSWORD: ""
      REDISSON_ADDRESS_PREFIX: redis://redis:6379
      # RabbitMQ配置
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SPRING_RABBITMQ_VIRTUAL_HOST: /
      # MongoDB配置
      SPRING_DATA_MONGODB_URI: mongodb://root:123456@mongodb:27017/init_db?authSource=admin
      # 邮箱配置（禁用）
      SPRING_MAIL_ENABLE: "false"
      # MinIO配置（禁用）
      MINIO_ENABLE: "false"
      # 阿里云OSS配置（禁用）
      ALIYUN_OSS_ENABLE: "false"
      # 腾讯云COS配置（禁用）
      COS_ENABLE: "false"
      # Elasticsearch配置（禁用）
      EASY_ES_ENABLE: "false"
      # AI配置（禁用）
      SPRING_AI_DEEPSDK_ENABLE: "false"
      SPRING_AI_OPENAI_ENABLE: "false"
      SPRING_AI_OLLAMA_ENABLE: "false"
      # 任务调度配置（禁用）
      XXL_JOB_ENABLE: "false"
      POWERJOB_WORKER_ENABLED: "false"
      # Spring Boot Admin配置（禁用）
      SPRING_BOOT_ADMIN_CLIENT_ENABLED: "false"
      # SA-Token配置
      SA_TOKEN_ENABLE_SA: "true"
      SA_TOKEN_ENABLE_JWT: "false"
      SA_TOKEN_TOKEN_NAME: Authorization
      SA_TOKEN_TIMEOUT: 86400
      SA_TOKEN_ACTIVE_TIMEOUT: 1800
      SA_TOKEN_IS_CONCURRENT: "false"
      SA_TOKEN_IS_SHARE: "false"
      SA_TOKEN_REDISJackson_DATABASE: 0
      SA_TOKEN_REDISJackson_HOST: redis
      SA_TOKEN_REDISJackson_PORT: 6379
      SA_TOKEN_REDISJackson_PASSWORD: ""
      # 验证码配置（禁用）
      CAPTCHA_ENABLE: "false"
      # 加密配置（禁用）
      ENCRYPT_ENABLE: "false"
      # 文件上传配置
      FILE_UPLOAD_PATH: ./upload
      FILE_MAX_SIZE: 12MB
      FILE_MAX_REQUEST_SIZE: 20MB
      # WebSocket配置（禁用）
      WEBSOCKET_NETTY_ENABLE: "false"
      WEBSOCKET_SPRING_ENABLE: "false"
      # Freemarker配置（禁用）
      SPRING_FREEMARKER_ENABLED: "false"
      # Caffeine缓存配置（禁用）
      CAFFEINE_ENABLE: "false"
      # 日志配置
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_TOP_SHAREHOME: DEBUG
      LOGGING_FILE_NAME: init.log
      LOGGING_FILE_PATH: ./logs
    ports:
      - "38080:38080"
    volumes:
      # 配置文件
      - ./data/spring-boot-init-template/logs/:/antony/springbootinittemplate/logs
      # 挂载JAR文件用于安全扫描
      - ./target.jar:/app/target.jar
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.200
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38080/api/auth/test"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mysql:
    image: mysql:8.0.43
    container_name: mysql
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: init_db
    volumes:
      - ./data/mysql/data/:/var/lib/mysql/
      - ./data/mysql/conf/:/etc/mysql/conf.d/
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1
      --skip-name-resolve
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.100
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.4.1
    container_name: redis
    ports: []
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ./data/redis/conf/:/redis/config/
      - ./data/redis/data/:/redis/data/
    command: redis-server /redis/config/redis.conf
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.103
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  rabbitmq:
    image: rabbitmq:3.13.7-management
    container_name: rabbitmq
    ports: []
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - ./data/rabbitmq/log/:/var/log/rabbitmq/
      - ./data/rabbitmq/data/:/var/lib/rabbitmq/
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.105
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  mongodb:
    image: mongodb/mongodb-community-server:7.0.12-ubi8
    container_name: mongodb
    ports: []
    volumes:
      - ./data/mongodb/data/:/data/db/
    environment:
      MONGODB_INITDB_ROOT_USERNAME: root
      MONGODB_INITDB_ROOT_PASSWORD: "123456"
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.109
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  nginx:
    image: nginx:1.27.1
    container_name: nginx
    environment:
      TZ: Asia/Shanghai
    ports:
      - "80:80"
    volumes:
      - ./data/nginx/cert:/etc/nginx/cert
      - ./data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./data/nginx/html:/usr/share/nginx/html
      - ./data/nginx/log:/var/log/nginx
    privileged: true
    networks:
      docker_net:
        ipv4_address: 177.177.177.201

networks:
  docker_net:
    external: true