services:
  n8n:
    image: n8nio/n8n:latest
    ports:
      - "40017:5678"
    environment:
      # Database configuration - using SQLite by default
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=database.sqlite
      - DB_SQLITE_POOL_SIZE=3
      - DB_SQLITE_ENABLE_WAL=true
      - DB_LOGGING_ENABLED=false

      # Security and encryption
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-your-encryption-key-here}
      - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_USER_MANAGEMENT_JWT_SECRET:-your-jwt-secret-here}
      - N8N_USER_MANAGEMENT_JWT_DURATION_HOURS=168
      - N8N_USER_MANAGEMENT_JWT_REFRESH_TIMEOUT_HOURS=0

      # General configuration
      - GENERIC_TIMEZONE=America/New_York
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console
      - ENVIRONMENT=production
      - NODE_ENV=production
      - PORT=5678
      - N8N_DEPLOYMENT_TYPE=default
      - N8N_RELEASE_TYPE=dev

      # Endpoint configuration
      - N8N_HOST=0.0.0.0
      - N8N_PROTOCOL=http
      - N8N_PORT=5678
      - WEBHOOK_URL=http://127.0.0.1:40017/
      - N8N_EDITOR_BASE_URL=http://127.0.0.1:40017/
      - N8N_ENDPOINT_REST=rest
      - N8N_ENDPOINT_WEBHOOK=webhook
      - N8N_ENDPOINT_WEBHOOK_TEST=webhook-test
      - N8N_ENDPOINT_FORM=form
      - N8N_ENDPOINT_FORM_TEST=form-test

      # File size limits
      - N8N_PAYLOAD_SIZE_MAX=16
      - N8N_FORMDATA_FILE_SIZE_MAX=200

      # Security settings
      - N8N_SECURE_COOKIE=true
      - N8N_SAMESITE_COOKIE=lax

      # Features
      - N8N_PUBLIC_API_DISABLED=false
      - N8N_PUBLIC_API_ENDPOINT=api/v1
      - N8N_DISABLE_UI=false
      - N8N_TEMPLATES_ENABLED=true
      - N8N_TEMPLATES_HOST=https://api.n8n.io

      # Workflow execution settings
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_TIMEOUT=300
      - EXECUTIONS_TIMEOUT_MAX=3600
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=false
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=10000

      # Cache settings
      - N8N_CACHE_BACKEND=memory
      - N8N_CACHE_MEMORY_MAX_SIZE=100
      - N8N_CACHE_MEMORY_TTL=300

      # Workflow auto-deactivation
      - N8N_WORKFLOW_AUTODEACTIVATION_ENABLED=true
      - N8N_WORKFLOW_AUTODEACTIVATION_MAX_LAST_EXECUTIONS=5

      # AI Features (optional - will be disabled if no API key provided)
      - N8N_AI_ENABLED=true
      - N8N_AI_API_ENABLED=true

      # Default workflow names
      - WORKFLOWS_DEFAULT_NAME=My workflow
      - CREDENTIALS_DEFAULT_NAME=My credential

      # File access restrictions
      - N8N_RESTRICT_FILE_ACCESS_TO=${N8N_USER_FOLDER:-~/.n8n-files}
      - N8N_BLOCK_FILE_ACCESS_TO_N8N_FILES=true

    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5678/healthz').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Optional: PostgreSQL database service
  # Uncomment and configure if you want to use PostgreSQL instead of SQLite
  #
  # postgres:
  #   image: postgres:15-alpine
  #   environment:
  #     - POSTGRES_DB=n8n
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=postgres
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1.0'
  #         memory: 2G
  #       reservations:
  #         cpus: '0.5'
  #         memory: 512M

  # Optional: Redis service for queue management
  # Uncomment if you need Redis for workflow queuing
  #
  # redis:
  #   image: redis:7-alpine
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M
  #       reservations:
  #         cpus: '0.25'
  #         memory: 128M

volumes:
  n8n_data:
    driver: local
  # postgres_data:
  #   driver: local