services:
  manga-translator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: manga-translator
    ports:
      - "40469:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      # API Keys (set these in .env or environment)
      - MT_WEB_NONCE=${MT_WEB_NONCE:-}
      - BAIDU_APP_ID=${BAIDU_APP_ID:-}
      - BAIDU_SECRET_KEY=${BAIDU_SECRET_KEY:-}
      - YOUDAO_APP_KEY=${YOUDAO_APP_KEY:-}
      - YOUDAO_SECRET_KEY=${YOUDAO_SECRET_KEY:-}
      - DEEPL_AUTH_KEY=${DEEPL_AUTH_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-chatgpt-4o-latest}
      - OPENAI_HTTP_PROXY=${OPENAI_HTTP_PROXY:-}
      - OPENAI_GLOSSARY_PATH=${OPENAI_GLOSSARY_PATH:-./dict/mit_glossary.txt}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - GROQ_MODEL=${GROQ_MODEL:-mixtral-8x7b-32768}
      - SAKURA_API_BASE=${SAKURA_API_BASE:-http://127.0.0.1:8080/v1}
      - SAKURA_VERSION=${SAKURA_VERSION:-0.9}
      - SAKURA_DICT_PATH=${SAKURA_DICT_PATH:-./dict/sakura_dict.txt}
      - CAIYUN_TOKEN=${CAIYUN_TOKEN:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash-002}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - DEEPSEEK_API_BASE=${DEEPSEEK_API_BASE:-https://api.deepseek.com}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      - TOGETHER_API_KEY=${TOGETHER_API_KEY:-}
      - TOGETHER_VL_MODEL=${TOGETHER_VL_MODEL:-Qwen/Qwen2.5-VL-72B-Instruct}
      - CUSTOM_OPENAI_API_KEY=${CUSTOM_OPENAI_API_KEY:-}
      - CUSTOM_OPENAI_API_BASE=${CUSTOM_OPENAI_API_BASE:-http://localhost:11434/v1}
      - CUSTOM_OPENAI_MODEL=${CUSTOM_OPENAI_MODEL:-}
      - CUSTOM_OPENAI_MODEL_CONF=${CUSTOM_OPENAI_MODEL_CONF:-}
    volumes:
      - ./dict:/app/dict
      - ./models:/app/models
      - ./fonts:/app/fonts
      - ./result:/app/result
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: unless-stopped