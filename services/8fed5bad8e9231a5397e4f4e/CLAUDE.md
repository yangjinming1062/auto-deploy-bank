# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Vega** visualization grammar - a declarative JSON-based format for creating interactive visualizations. Vega 6.x is a modular monorepo with 36 packages that work together.

## Common Commands

```bash
# Install dependencies (required after clone)
npm install

# Build all packages
npm run build

# Run all tests (includes linting and type checking)
npm test

# Run tests only (skip lint)
npm run test:no-lint

# Run linting
npm run lint

# Fix linting issues
npm run format

# TypeScript type checking
npm run typecheck

# Run a single test file
npm run build && tape 'path/to/test.js'

# Run tests for a specific package (from package directory)
cd packages/vega-dataflow && npm test

# Serve test files locally
npm run serve
```

## Architecture

### Core Packages

- **vega** - Main bundle that aggregates all packages; exports the public API
- **vega-dataflow** - Reactive dataflow engine; the core runtime system
- **vega-parser** - Parses Vega JSON specifications into runtime dataflows
- **vega-runtime** - Executes parsed dataflows and builds scenegraphs
- **vega-scenegraph** - Scenegraph representation and Canvas/SVG renderers
- **vega-util** - Utility functions (written in TypeScript)

### Dataflow Pipeline

```
JSON Spec → vega-parser → vega-runtime → vega-scenegraph → Renderers
                ↓
         vega-dataflow (reactive engine)
         vega-transforms (data transformations)
```

### Package Structure

Most packages follow this pattern:
```
packages/{package-name}/
├── src/           # Source files (.js, or .ts for some packages)
├── test/          # tape tests (*-test.js)
├── build/         # Generated output (generated by build)
├── index.js       # Main entry point
├── package.json
└── rollup.config.js
```

### Key Concepts

- **Dataflow**: Reactive stream processing system with operators, pulses, tuples
- **Transforms**: Data transformation operators (filters, aggregates, etc.)
- **Scenegraph**: Scene graph tree structure for rendering
- **Marks**: Visual elements (rect, circle, line, text, etc.)
- **Selections**: Interactive data selection mechanisms

### Dependencies

- **d3**: Used throughout for data manipulation (scales, shapes, colors, geo, etc.)
- **tape**: Testing framework for all tests
- **Rollup**: Bundle generation with Babel transpilation
- **TypeScript**: Type definitions in vega-util and vega-typings only; main code is JavaScript

### Build Targets

The root `rollup.config.js` produces:
- ESM modules for npm
- UMD bundles (vega.min.js, vega-core.min.js) for CDN use
- Source maps for debugging

### Linting Rules

- ESLint with TypeScript ESLint plugin
- Single quotes, no trailing commas
- `no-console` is an error (use logging utilities from vega-util)
- Legacy rules disabled for existing code (var-requires, unused-vars, etc.)