#
# Copyright Â© 2016-2025 The Thingsboard Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: thingsboard
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d thingsboard"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - thingsboard-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  valkey:
    image: valkey/valkey:8-alpine
    restart: unless-stopped
    command: valkey-server --appendonly yes
    volumes:
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - thingsboard-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  zookeeper:
    image: zookeeper:3.8
    restart: unless-stopped
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;zookeeper:2181
      ZOO_ADMINSERVER_ENABLED: "false"
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    volumes:
      - zookeeper_data:/data
      - zookeeper_logs:/datalog
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc zookeeper 2181 | grep -q imok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - thingsboard-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  kafka:
    image: bitnamilegacy/kafka:4.0
    restart: unless-stopped
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: false
      KAFKA_CFG_LOG_RETENTION_BYTES: 1073741824
      KAFKA_CFG_SEGMENT_BYTES: 26214400
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - thingsboard-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    depends_on:
      zookeeper:
        condition: service_healthy

  thingsboard:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TAG=${TAG:-latest}
    image: app-thingsboard-${TAG:-latest}
    restart: unless-stopped
    ports:
      - "40314:8080"
    environment:
      # Database configuration
      DATABASE_TS_TYPE: sql
      SPRING_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/thingsboard
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_DATASOURCE_MAXIMUM_POOL_SIZE: "16"
      SPRING_DATASOURCE_HIKARI_LEAK_DETECTION_THRESHOLD: "0"
      SPRING_DATASOURCE_HIKARI_REGISTER_MBEANS: "false"

      # Cache configuration
      CACHE_TYPE: redis
      REDIS_HOST: valkey
      REDIS_PORT: "6379"
      REDIS_CONNECTION_TYPE: standalone
      REDIS_PASSWORD: ""
      REDIS_DB: "0"

      # Queue configuration
      TB_QUEUE_TYPE: kafka
      TB_KAFKA_SERVERS: kafka:9092
      ZOOKEEPER_ENABLED: true
      ZOOKEEPER_URL: zookeeper:2181

      # Service configuration
      JS_EVALUATOR: remote
      TRANSPORT_TYPE: remote
      HTTP_BIND_ADDRESS: 0.0.0.0
      HTTP_BIND_PORT: "8080"
      SSL_ENABLED: "false"

      # Metrics configuration
      METRICS_ENABLED: "true"
      METRICS_ENDPOINTS_EXPOSE: prometheus

      # Security configuration
      JWT_TOKEN_EXPIRATION_TIME: "9000"
      JWT_REFRESH_TOKEN_EXPIRATION_TIME: "604800"
      JWT_TOKEN_ISSUER: thingsboard.io
      JWT_TOKEN_SIGNING_KEY: thingsboardDefaultSigningKey

      # Logging configuration
      HTTP_LOG_CONTROLLER_ERROR_STACK_TRACE: "false"
      SPRING_MVC_ASYNC_REQUEST_TIMEOUT: "30000"

      # UI configuration
      UI_HELP_BASE_URL: https://raw.githubusercontent.com/thingsboard/thingsboard-ui-help/release-4.3
      USAGE_STATS_REPORT_ENABLED: "true"
      USAGE_STATS_REPORT_INTERVAL: "60"
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/api/version | grep -q '200\\|401'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - thingsboard-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    volumes:
      - ./target.jar:/app/target.jar
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy

networks:
  thingsboard-network:
    driver: bridge

volumes:
  postgres_data:
  valkey_data:
  zookeeper_data:
  zookeeper_logs:
  kafka_data: