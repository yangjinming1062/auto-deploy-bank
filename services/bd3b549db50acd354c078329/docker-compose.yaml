services:
  rackshift-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rackshift-server
    networks:
      - rackshift-network
    ports:
      - "40707:8082"
    volumes:
      - ./target.jar:/app/target.jar:ro
      - ./rackshift.properties:/opt/rackshift/conf/rackshift.properties:ro
      - rackshift-logs:/opt/rackshift/logs
      - rackshift-conf:/opt/rackshift/conf
      - rackshift-uploads:/opt/rackshift/uploads
    environment:
      - web.server.port=8082
      - server.port=8082
      - spring.flyway.enabled=true
      - spring.datasource.url=jdbc:mysql://mysql:3306/rackshift?characterEncoding=utf-8&useSSL=false
      - spring.datasource.username=root
      - spring.datasource.password=admin
      - spring.rabbitmq.host=rabbitmq
      - spring.rabbitmq.port=5672
      - spring.rabbitmq.username=guest
      - spring.rabbitmq.password=guest
      - amqp.uri=amqp://guest:guest@rabbitmq:5672
      - run.mode=docker
      - api.server.url=http://localhost:8082
      - api.server.port=8082
      - file.server=localhost
      - file.server.port=8082
      - file.upload.dir=/opt/rackshift/uploads
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  mysql:
    image: mysql:5.7
    container_name: rackshift-mysql
    networks:
      - rackshift-network
    environment:
      - MYSQL_ROOT_PASSWORD=admin
      - MYSQL_DATABASE=rackshift
      - MYSQL_USER=rackshift
      - MYSQL_PASSWORD=admin
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-padmin"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rackshift-rabbitmq
    networks:
      - rackshift-network
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  rackshift-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  rabbitmq-data:
    driver: local
  rackshift-logs:
    driver: local
  rackshift-conf:
    driver: local
  rackshift-uploads:
    driver: local
