services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: open_agent
      POSTGRES_USER: open-agent
      POSTGRES_PASSWORD: open-agent
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U open-agent -d open_agent']
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - internal_network
    # No port exposure - internal only

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - internal_network
    # No port exposure - internal only

  app-init:
    build:
      context: /home/ubuntu/deploy-projects/211b53099bb8e313679d4ce4
      dockerfile: .docker/Dockerfile
      target: production
    environment:
      - SERVER_FLAVOR=script
      - DATABASE_URL=postgres://open-agent:open-agent@postgres:5432/open_agent
      - REDIS_SERVER_HOST=redis
      - REDIS_SERVER_PORT=6379
      - REDIS_SERVER_DATABASE=0
      - NODE_ENV=production
      - OPEN_AGENT_ENV=production
      - OPEN_AGENT_SERVER_HOST=0.0.0.0
      - OPEN_AGENT_SERVER_PORT=3010
      - OPEN_AGENT_SERVER_HTTPS=false
    command: ["sh", "-c", "npx prisma migrate deploy && node dist/main.mjs run"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: 'no'
    networks:
      - internal_network

  app:
    build:
      context: /home/ubuntu/deploy-projects/211b53099bb8e313679d4ce4
      dockerfile: .docker/Dockerfile
      target: production
    environment:
      - SERVER_FLAVOR=allinone
      - DATABASE_URL=postgres://open-agent:open-agent@postgres:5432/open_agent
      - REDIS_SERVER_HOST=redis
      - REDIS_SERVER_PORT=6379
      - REDIS_SERVER_DATABASE=0
      - NODE_ENV=production
      - OPEN_AGENT_ENV=production
      - OPEN_AGENT_SERVER_HOST=0.0.0.0
      - OPEN_AGENT_SERVER_PORT=3010
      - OPEN_AGENT_SERVER_HTTPS=false
    ports:
      - '40137:3010'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      app-init:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - internal_network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

networks:
  internal_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data: