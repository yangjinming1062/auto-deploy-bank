#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

services:
  gravitino:
    build:
      context: .
      dockerfile: Dockerfile
    image: gravitino:latest
    container_name: gravitino-server
    hostname: gravitino

    # Environment variables
    environment:
      - GRAVITINO_HOME=/app
      - GRAVITINO_CONF_DIR=/app/conf
      - GRAVITINO_LOG_DIR=/app/logs
      - GRAVITINO_MEM=-Xms1024m -Xmx1024m -XX:MaxMetaspaceSize=512m

    # Port mapping (main server port 8090 mapped to host port 40189)
    ports:
      - "40189:8090"
      # Additional ports for iceberg-rest and lance-rest (internal only, not exposed to host)
      # These services communicate internally via Docker network
      # - "9001:9001"  # Not exposed to host
      # - "9101:9101"  # Not exposed to host

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/api/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

    # Restart policy
    restart: unless-stopped

    # Volumes for configuration (optional, can be mounted if needed)
    # Uncomment if you want to mount external config files
    # volumes:
    #   - ./conf:/app/conf:ro

    # Wait for service to be healthy before considering it started
    # The healthcheck defined above handles this automatically

    # Volume mount for security scanning - creates target.jar inside container
    # The JAR file is dynamically created by docker-entrypoint.sh
    # If you need to scan this file from host, uncomment the line below and create target.jar on host
    # volumes:
    #   - ./target.jar:/app/target.jar